<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Saber 11 ‚Äî Alba & Lara (Estudio ‚Ä¢ Pr√°ctica ‚Ä¢ Simulador)</title>
<style>
  :root{
    --bg:#ffffff;--card:#ffffff;--muted:#666;--border:#ddd;
    --ok:#1e7d32;--okbg:#d9fdd3;--bad:#c62828;--badbg:#fde8e8;
    --accent:#1a73e8;--accentText:#fff;
  }
  [data-theme="Alba"]{ --accent:#e91e63; --accentText:#fff; }
  [data-theme="Lara"]{ --accent:#7e57c2; --accentText:#fff; }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;margin:16px;max-width:980px;background:var(--bg)}
  h1,h2{margin:.2em 0}
  .card{border:1px solid var(--border);border-radius:12px;padding:16px;margin:12px 0;background:var(--card);box-shadow:0 1px 0 rgba(0,0,0,.02)}
  .muted{color:var(--muted)}
  .small{font-size:12px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .col{display:flex;flex-direction:column;gap:6px}
  button,select,input{font-size:16px;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
  button.accent{background:var(--accent);color:var(--accentText);border-color:var(--accent)}
  .option{display:block;width:100%;text-align:left;margin:8px 0;padding:12px;border:1px solid #ccc;border-radius:10px;cursor:pointer;background:#fafafa;transition:background .2s,border-color .2s,transform .05s}
  .option:active{transform:scale(0.99)}
  .option.correct{border-color:var(--ok);background:var(--okbg)}
  .option.incorrect{border-color:var(--bad);background:var(--badbg)}
  .pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:4px 10px;margin-right:8px;font-size:12px}
  .hidden{display:none}
  header.appbar{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;margin:8px 0 16px}
  header.appbar .spacer{flex:1}
  .result{margin-top:8px;font-weight:700}
  .result.good{color:var(--ok)}
  .result.bad{color:var(--bad)}
  .score{font-weight:700;color:#111}
  .grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
  .timer{font-weight:700}
  .list{list-style:none;padding-left:0;margin:0}
  .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;margin:4px 6px 0 0}
  .nav{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .nav button{border-color:var(--accent);color:var(--accent);background:#fff}
  .nav button.active{background:var(--accent);color:var(--accentText)}
  .title{display:flex;align-items:center;gap:8px}
  .title .chip{background:var(--accent);color:var(--accentText);border-radius:999px;padding:4px 10px;font-size:12px}
  canvas{max-width:100%}
</style>
</head>
<body>
<section id="loginView" class="card">
  <h1>üëã Hola</h1>
  <p>Elige qui√©n va a practicar hoy y escribe su clave (PIN de 4 d√≠gitos).</p>
  <div class="grid">
    <div class="card">
      <div class="title"><h2>Alba</h2><span class="chip">Rosa</span></div>
      <div class="muted small">Puntos: <span id="albaPoints" class="score">0</span> ¬∑ Medallas: <span id="albaBadgesCount">0</span></div>
      <div class="row">
        <input id="pinAlba" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="PIN (4 d√≠gitos)">
        <button class="accent" onclick="enterWithPIN('Alba', 'pinAlba')">Entrar</button>
      </div>
      <div class="small muted">Primer uso: el PIN que escribas quedar√° guardado.</div>
    </div>
    <div class="card">
      <div class="title"><h2>Lara</h2><span class="chip">Morado</span></div>
      <div class="muted small">Puntos: <span id="laraPoints" class="score">0</span> ¬∑ Medallas: <span id="laraBadgesCount">0</span></div>
      <div class="row">
        <input id="pinLara" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="PIN (4 d√≠gitos)">
        <button class="accent" onclick="enterWithPIN('Lara', 'pinLara')">Entrar</button>
      </div>
      <div class="small muted">Primer uso: el PIN que escribas quedar√° guardado.</div>
    </div>
  </div>
</section>

<section id="appView" class="hidden">
  <header class="appbar">
    <div><b>Usuario:</b> <span id="who"></span></div>
    <div class="spacer"></div>
    <div class="nav">
      <button id="navStudy" class="active">Estudio</button>
      <button id="navPractice">Pr√°ctica</button>
      <button id="navExam">Simulador</button>
      <button id="navDaily">Reto diario</button>
      <button id="navHistory">Historial</button>
      <button id="navBadges">Medallas</button>
    </div>
    <div class="spacer"></div>
    <button onclick="logout()">Cerrar sesi√≥n</button>
  </header>

  <!-- ===== STUDY ===== -->
  <section id="studyView" class="card">
    <h2>üìö Estudio</h2>
    <div class="row">
      <div class="col">
        <label class="small">Asignatura</label>
        <select id="studySubject"></select>
      </div>
      <div class="col">
        <label class="small">Tema</label>
        <select id="studyTopic"></select>
      </div>
      <div class="spacer"></div>
      <div class="col">
        <label class="small">Acciones</label>
        <button id="studyPractice" class="accent">Practicar este tema</button>
      </div>
    </div>
    <div id="studyContent" class="card" style="background:#f9fafc"></div>
    <div id="studyExamples" class="card hidden"></div>
    <div id="studyQ" class="card hidden">
      <div id="studyStem" style="font-weight:600"></div>
      <div id="studyOpts"></div>
      <div id="studyResult" class="result hidden"></div>
      <div id="studyExplain" class="small muted hidden"></div>
    </div>
  </section>

  <!-- ===== PRACTICE ===== -->
  <section id="practiceView" class="card hidden">
    <div class="row">
      <div class="col">
        <label class="small">Asignatura</label>
        <select id="subject"></select>
      </div>
      <div class="col">
        <label class="small">Tema</label>
        <select id="topic"></select>
      </div>
      <div class="spacer"></div>
      <div class="col">
        <label class="small">Acciones</label>
        <div class="row">
          <button id="reset">Reiniciar progreso (tema)</button>
        </div>
      </div>
    </div>
    <div id="stats" class="muted small" style="margin-top:8px"></div>
    <hr>
    <div id="meta" class="muted small" style="margin-bottom:8px"></div>
    <div id="question" style="font-size:18px;font-weight:600"></div>
    <div id="result" class="result hidden"></div>
    <div id="options"></div>
    <div id="explanation" class="card hidden" style="background:#f9fafc"></div>
    <div class="row" style="margin-top:8px">
      <button id="similar" class="hidden">Similar (autom√°tica)</button>
      <button id="next" class="accent hidden">Siguiente pregunta</button>
    </div>
  </section>

  <!-- ===== EXAM ===== -->
  <section id="examView" class="card hidden">
    <h2>Simulador Saber 11</h2>
    <div class="row">
      <div class="col">
        <label class="small">Cantidad</label>
        <select id="examCount">
          <option value="45" selected>45</option>
          <option value="30">30</option>
          <option value="60">60</option>
        </select>
      </div>
      <div class="col">
        <label class="small">Tiempo</label>
        <select id="examMinutes">
          <option value="90" selected>90 min</option>
          <option value="60">60 min</option>
          <option value="45">45 min</option>
        </select>
      </div>
      <div class="col" style="align-self:flex-end">
        <button class="accent" onclick="startExam()">Comenzar</button>
      </div>
    </div>
    <p class="small muted">Durante el examen no sabr√°s si aciertas; al final ver√°s el resumen con explicaciones.</p>
    <section id="examCard" class="card hidden">
      <div class="row">
        <div><b>Pregunta</b> <span id="examIndex">1</span>/<span id="examTotal">45</span></div>
        <div class="spacer"></div>
        <div class="timer">‚è± <span id="examTimer">90:00</span></div>
      </div>
      <div id="examQ" style="font-size:18px;font-weight:600;margin-top:6px"></div>
      <div id="examOptions"></div>
      <div class="row" style="margin-top:8px">
        <button id="examPrev">Anterior</button>
        <button id="examNext" class="accent">Siguiente</button>
        <div class="spacer"></div>
        <button onclick="finishExam()" class="accent">Finalizar</button>
      </div>
    </section>
    <section id="examSummary" class="card hidden">
      <h3>Resultados</h3>
      <p><b>Correctas:</b> <span id="sumCorrect">0</span> / <span id="sumTotal">0</span> ‚Äî <b>Puntos:</b> <span id="sumScore">0</span></p>
      <ol id="sumList" class="list"></ol>
    </section>
  </section>

  <!-- ===== DAILY CHALLENGE ===== -->
  <section id="dailyView" class="card hidden">
    <h2>üî• Reto diario</h2>
    <p class="small muted">10 preguntas mixtas. Completar sin fallos da <b>puntuaci√≥n doble</b>.</p>
    <div id="dailyCard" class="card hidden">
      <div><b>Pregunta</b> <span id="dailyIndex">1</span>/10</div>
      <div id="dailyQ" style="font-size:18px;font-weight:600;margin-top:6px"></div>
      <div id="dailyOptions"></div>
      <div id="dailyResult" class="result hidden"></div>
      <div id="dailyExplain" class="small muted hidden"></div>
      <div class="row" style="margin-top:8px">
        <button id="dailyNext" class="accent">Siguiente</button>
      </div>
    </div>
    <div id="dailyStart" class="row">
      <button class="accent" onclick="startDaily()">Comenzar reto de hoy</button>
    </div>
    <div id="dailyDone" class="hidden"><b>‚úÖ Reto del d√≠a completado.</b></div>
  </section>

  <!-- ===== HISTORY ===== -->
  <section id="historyView" class="card hidden">
    <h2>üìà Historial</h2>
    <canvas id="histChart" width="900" height="220"></canvas>
    <ul id="histList" class="list"></ul>
  </section>

  <!-- ===== BADGES ===== -->
  <section id="badgesView" class="card hidden">
    <h2>üèÖ Medallas</h2>
    <div id="badgesBox"></div>
  </section>
</section>

<script>
/* ================== UTILIDADES ================== */
const $ = sel => document.querySelector(sel);
function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function sample(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function shuffle(arr){ return arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]); }
function fmtTime(s){ const m=Math.floor(s/60), r=s%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`; }
function todayKey(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

/* ================== TEMAS DE ESTUDIO (contenido) ================== */
const STUDY = {
  "Matem√°ticas": {
    "√Ålgebra": {
      theory: `<h3>Ecuaciones lineales</h3>
      <p>Una ecuaci√≥n lineal tiene la forma <i>ax + b = c</i>. La estrategia universal es aislar la inc√≥gnita con operaciones inversas y de igual forma a ambos lados: primero eliminamos la constante (sumando o restando), y luego despejamos dividiendo por el coeficiente de <i>x</i>. Este procedimiento conserva la igualdad y permite verificar el resultado sustituyendo de nuevo en la ecuaci√≥n original.</p>`,
      examples: [
        {title:"Ejemplo 1", steps:["3x + 2 = 14","3x = 12","x = 4"]},
        {title:"Ejemplo 2", steps:["5x ‚àí 10 = 0","5x = 10","x = 2"]}
      ],
      guided: () => {
        const a=randInt(2,9), x=randInt(1,10), b=randInt(1,10); const c=a*x+b;
        const ans=(c-b)/a; const opts=shuffle([ans, ans+1, ans-1, ans+2]).map(String);
        return { stem:`Resuelve: ${a}x + ${b} = ${c}`, choices:opts, answerIndex:opts.indexOf(String(ans)), explain:`Para resolver una ecuaci√≥n lineal como ${a}x + ${b} = ${c}, aplicamos operaciones inversas en ambos lados. Primero restamos ${b} a ambos lados para eliminar la constante y obtener ${a}x = ${c-b}. Luego dividimos entre ${a} para aislar la inc√≥gnita y llegamos a x = ${(c-b)}/${a} = ${ans}. Comprueba sustituyendo: ${a}¬∑${ans} + ${b} = ${c-b+ b} = ${c}, lo que confirma que el valor hallado satisface la igualdad.` };
      }
    },
    "Geometr√≠a": {
      theory:`<h3>Pit√°goras</h3><p>En un tri√°ngulo rect√°ngulo se cumple <i>a¬≤ + b¬≤ = c¬≤</i>, donde <i>c</i> es la hipotenusa. Esta relaci√≥n surge de √°reas de cuadrados construidos sobre los lados y permite calcular longitudes cuando se conocen las otras dos.</p>`,
      examples:[{title:"Ejemplo", steps:["Catetos 6 y 8","c=‚àö(36+64)=‚àö100=10"]}],
      guided: ()=>{
        const sets=[[3,4,5],[5,12,13],[6,8,10]]; const t=sample(sets); const [a,b,c]=t;
        const opts=shuffle([c,c+1,c-1,c+2]).map(String);
        return {stem:`Catetos ${a} y ${b}. ¬øHipotenusa?`, choices:opts, answerIndex:opts.indexOf(String(c)), explain:`El teorema de Pit√°goras indica que, en un tri√°ngulo rect√°ngulo, la suma de los cuadrados de los catetos es igual al cuadrado de la hipotenusa. Sustituyendo: c = ‚àö(${a}¬≤ + ${b}¬≤) = ‚àö(${a*a} + ${b*b}) = ‚àö(${a*a + b*b}) = ${c}. Esta propiedad es muy √∫til para estimar distancias y validar si un tri√°ngulo es rect√°ngulo.`};
      }
    }
  },
  "Ciencias Naturales": {
    "Biolog√≠a": {
      theory:`<h3>Org√°nulos</h3><p>Las c√©lulas tienen estructuras especializadas: el cloroplasto capta energ√≠a luminosa para la fotos√≠ntesis, la mitocondria transforma nutrientes en ATP en la respiraci√≥n celular, los ribosomas ensamblan prote√≠nas y el n√∫cleo protege el ADN y regula la actividad celular.</p>`,
      examples:[{title:"Ejemplo", steps:["¬øQu√© hace el cloroplasto? ‚Üí Fotos√≠ntesis"]}],
      guided: ()=>{
        const pairs=[["Cloroplasto","Fotos√≠ntesis"],["Mitocondria","Respiraci√≥n celular"],["Ribosoma","S√≠ntesis de prote√≠nas"],["N√∫cleo","Almacena ADN"]];
        const [org,func]=sample(pairs); const wrong=shuffle(pairs.filter(p=>p[0]!==org).map(p=>p[1])).slice(0,3);
        const all=shuffle([func,...wrong]);
        return {stem:`Funci√≥n principal de ${org}:`, choices:all, answerIndex:all.indexOf(func), explain:`Identificar la funci√≥n de un org√°nulo exige relacionarlo con el proceso que lidera. El ${org} est√° asociado a ‚Äú${func}‚Äù. Por ejemplo, los cloroplastos contienen clorofila y convierten energ√≠a lum√≠nica en qu√≠mica durante la fotos√≠ntesis; las mitocondrias generan ATP a partir de nutrientes; los ribosomas ensamblan amino√°cidos en prote√≠nas y el n√∫cleo resguarda la informaci√≥n gen√©tica.`};
      }
    },
    "Qu√≠mica": {
      theory:`<h3>Molaridad (M)</h3><p>La molaridad expresa cu√°ntos moles de soluto hay en un litro de soluci√≥n: M = n/V. Es una unidad central para preparar soluciones y calcular reacciones estequiom√©tricas de manera cuantitativa.</p>`,
      examples:[{title:"Ejemplo", steps:["2 mol en 1 L ‚Üí 2 M"]}],
      guided: ()=>{
        const mol=randInt(1,3), L=randInt(1,3); const M=(mol/L).toFixed(2);
        const opts=shuffle([M,(mol/(L+1)).toFixed(2),(mol/(L+2)).toFixed(2),(mol/(L+0.5)).toFixed(2)]);
        return {stem:`${mol} mol en ${L} L. ¬øM?`, choices:opts, answerIndex:opts.indexOf(String(M)), explain:`La molaridad es la cantidad de soluto por litro de soluci√≥n. Si tenemos ${mol} mol distribuidos uniformemente en ${L} L, la concentraci√≥n es M = n/V = ${mol}/${L} = ${M} M. Esta medida permite comparar soluciones y predecir cantidades que reaccionar√°n seg√∫n proporciones establecidas por las ecuaciones qu√≠micas.`};
      }
    }
  },
  "Sociales": {
    "Historia de Colombia": {
      theory:`<h3>Fechas clave</h3><ul><li>1810: inicio del proceso de independencia.</li><li>1819: Batalla de Boyac√°.</li><li>1821: Constituci√≥n de C√∫cuta y consolidaci√≥n de la Gran Colombia.</li></ul>`,
      examples:[{title:"Ejemplo", steps:["¬øQu√© ocurri√≥ en 1819? ‚Üí Boyac√°"]}],
      guided: ()=>{
        const items=[["1810","inicio proceso de independencia"],["1819","Batalla de Boyac√°"],["1821","Constituci√≥n de C√∫cuta"]];
        const [anio,desc]=sample(items); const opts=shuffle([anio,"1816","1830","1849"]);
        return {stem:`A√±o asociado a: ${desc}`, choices:opts, answerIndex:opts.indexOf(anio), explain:`Relacionar procesos hist√≥ricos con fechas ayuda a entender la secuencia de eventos. El ${desc} se vincula con ${anio}, parte de un periodo en el que se consolidan proyectos pol√≠ticos y militares que dan forma al Estado moderno y a su ordenamiento jur√≠dico.`};
      }
    },
    "Geograf√≠a": {
      theory:`<h3>R√≠os principales</h3><p>El Magdalena organiza gran parte de la vida econ√≥mica y cultural del pa√≠s. Otros r√≠os importantes son el Cauca, Orinoco, Amazonas (frontera) y Putumayo, cada uno con cuencas de relevancia ecol√≥gica y productiva.</p>`,
      examples:[{title:"Ejemplo", steps:["M√°s largo de Colombia ‚Üí Magdalena"]}],
      guided: ()=>{
        const correct="Magdalena"; const opts=shuffle([correct,"Cauca","Putumayo","Orinoco"]);
        return {stem:`R√≠o m√°s largo de Colombia`, choices:opts, answerIndex:opts.indexOf(correct), explain:`El r√≠o Magdalena es el m√°s largo del pa√≠s y articul√≥ durante siglos rutas de comercio y poblamiento. Su cuenca integra numerosos afluentes y ecosistemas, por lo que identificarlo correctamente permite ubicar procesos hist√≥ricos, econ√≥micos y ambientales clave para Colombia.`};
      }
    }
  },
  "Lectura Cr√≠tica": {
    "Idea principal": {
      theory:`<h3>Idea principal</h3><p>La idea principal condensa en una oraci√≥n el mensaje central de un texto. Para hallarla, identifica: tema, actitud del autor y oraci√≥n con mayor generalidad y cohesi√≥n respecto del resto.</p>`,
      examples:[{title:"Ejemplo", steps:["Texto sobre abejas ‚Üí Idea: su papel clave en polinizaci√≥n."]}],
      guided: ()=>{
        const a=sample(["abejas","manglares","bosques urbanos"]); const b=a==="abejas"?"polinizaci√≥n":(a==="manglares"?"costas":"temperatura");
        const p=`Los ${a} son esenciales para la ${b}.`;
        const correct=`Los ${a} son esenciales para la ${b}.`;
        const opts=shuffle([correct,`Se critica a los ${a}.`,`Son irrelevantes.`,`Solo importan en laboratorios.`]);
        return {stem:`Texto: ‚Äú${p}‚Äù ¬øIdea principal?`, choices:opts, answerIndex:opts.indexOf(correct), explain:`La oraci√≥n que mejor resume el hilo argumental es la que integra el tema y la valoraci√≥n del autor: ‚ÄúLos ${a} son esenciales para la ${b}‚Äù. Las alternativas restantes distorsionan el tono o niegan la relevancia indicada por el texto.`};
      }
    }
  },
  "Ingl√©s": {
    "Vocabulary": {
      theory:`<h3>Synonyms</h3><p>Un sin√≥nimo expresa una idea cercana en otro t√©rmino. Elegir el mejor depende del contexto: ‚Äúreliable‚Äù encaja con ‚Äútrustworthy‚Äù, especialmente cuando describe a una persona o fuente en la que se puede confiar.</p>`,
      examples:[{title:"Ejemplo", steps:["smart ‚âà intelligent"]}],
      guided: ()=>{
        const pairs=[["reliable","trustworthy"],["quick","rapid"],["smart","intelligent"],["tiny","small"]];
        const [w,syn]=sample(pairs); const wrong=shuffle(pairs.filter(p=>p[0]!==w).map(p=>p[1])).slice(0,3);
        const all=shuffle([syn,...wrong]);
        return {stem:`Best synonym for ‚Äú${w}‚Äù:`, choices:all, answerIndex:all.indexOf(syn), explain:`Para seleccionar sin√≥nimos considera uso y matiz: ‚Äú${w}‚Äù se aproxima a ‚Äú${syn}‚Äù, pues ambos describen una cualidad equivalente en registros comunes. Otras opciones pertenecen a campos sem√°nticos distintos o no encajan en el contexto general.`};
      }
    }
  }
};

/* ================== PREGUNTAS (fijas + plantillas con explicaciones amplias) ================== */
const FIXED_QUESTIONS = [
  {id:"m-alg-1", subject:"Matem√°ticas", topic:"√Ålgebra",
   stem:"Si 3x + 2 = 20, ¬øcu√°nto vale x?",
   choices:["4","5","6","7"], answerIndex:2, difficulty:0.30,
   explain:"Para resolver 3x + 2 = 20, aplicamos el principio de mantener la igualdad realizando la misma operaci√≥n en ambos lados. Restamos 2 y obtenemos 3x = 18. Luego dividimos por 3 para aislar la inc√≥gnita: x = 6. Una verificaci√≥n r√°pida consiste en sustituir x = 6 en la expresi√≥n inicial: 3¬∑6 + 2 = 18 + 2 = 20. Esta comprobaci√≥n confirma que el valor hallado satisface completamente la ecuaci√≥n."
  },
  {id:"m-geo-1", subject:"Matem√°ticas", topic:"Geometr√≠a",
   stem:"Un tri√°ngulo rect√°ngulo tiene catetos 3 y 4. ¬øHipotenusa?",
   choices:["4","5","6","7"], answerIndex:1, difficulty:0.30,
   explain:"El teorema de Pit√°goras se√±ala que, en todo tri√°ngulo rect√°ngulo, la suma de los cuadrados de los catetos es igual al cuadrado de la hipotenusa: c¬≤ = a¬≤ + b¬≤. Sustituyendo: c¬≤ = 3¬≤ + 4¬≤ = 9 + 16 = 25. Al extraer la ra√≠z cuadrada, c = ‚àö25 = 5. Este resultado es un caso cl√°sico que ilustra la relaci√≥n entre lados y es √∫til para validar medidas o planear trazos perpendiculares con precisi√≥n."
  },
  {id:"c-q-1", subject:"Ciencias Naturales", topic:"Qu√≠mica",
   stem:"¬øCu√°l es la masa molar aproximada del H‚ÇÇO?",
   choices:["18 g/mol","16 g/mol","20 g/mol","14 g/mol"], answerIndex:0, difficulty:0.25,
   explain:"Para calcular la masa molar del agua, sumamos los aportes at√≥micos: el hidr√≥geno tiene masa at√≥mica cercana a 1 g/mol y aparecen dos √°tomos (2√ó1 = 2). El ox√≠geno contribuye con ~16 g/mol. La suma total es 2 + 16 = 18 g/mol. Este valor es fundamental para convertir entre cantidad de sustancia (moles) y masa en reacciones qu√≠micas y preparaciones de soluciones."
  },
  {id:"lc-inf-1", subject:"Lectura Cr√≠tica", topic:"Inferencias",
   stem:"El autor 'lamenta el deterioro ambiental'. Inferir que apoya pol√≠ticas de protecci√≥n se basa en‚Ä¶",
   choices:["Afirmaci√≥n expl√≠cita","Dato","Implicatura razonable","Falacia"], answerIndex:2, difficulty:0.40,
   explain:"La conclusi√≥n de que el autor apoya pol√≠ticas de protecci√≥n no est√° enunciada de forma literal, sino que se deduce del tono y la valoraci√≥n expresada por el verbo ‚Äúlamenta‚Äù. Esta es una implicatura razonable: el lamento por el deterioro sugiere preferencia por acciones que lo mitiguen. Distinguir entre lo dicho y lo implicado es clave para una lectura cr√≠tica s√≥lida."
  },
  {id:"en-v-1", subject:"Ingl√©s", topic:"Vocabulary",
   stem:"Choose the best synonym for 'reliable':",
   choices:["trustworthy","fragile","temporary","careless"], answerIndex:0, difficulty:0.30,
   explain:"‚ÄúReliable‚Äù describe algo o alguien en quien se puede confiar de manera consistente. Por ello, ‚Äútrustworthy‚Äù es el sin√≥nimo que mejor conserva el matiz de confiabilidad. Las otras opciones reflejan fragilidad, temporalidad o descuido, ideas que no se alinean con el significado del t√©rmino en contextos cotidianos."
  },
  {id:"soc-his-1", subject:"Sociales", topic:"Historia de Colombia",
   stem:"¬øEn qu√© batalla se sell√≥ la independencia en 1819?",
   choices:["Boyac√°","Ayacucho","Chacabuco","Jun√≠n"], answerIndex:0, difficulty:0.35,
   explain:"La Batalla de Boyac√° (7 de agosto de 1819) es considerada decisiva en la Campa√±a Libertadora. Su desenlace aceler√≥ la ca√≠da del dominio realista en Nueva Granada y abri√≥ la puerta a la consolidaci√≥n institucional posterior. Identificar esta fecha y lugar permite ubicar un hito central del proceso independentista colombiano."
  }
];

const TEMPLATES = [
  {subject:"Matem√°ticas", topic:"√Ålgebra", difficulty:0.30, build:()=>{
    let a,b,c,x; for(let i=0;i<50;i++){ a=randInt(2,9); b=randInt(1,15); x=randInt(1,15); c=a*x+b; if((c-b)%a===0) break; }
    const ans=(c-b)/a, opts=shuffle([ans, ans+1, ans-1, ans+2]).map(String);
    const explain = `Para resolver ${a}x + ${b} = ${c}, usamos operaciones inversas manteniendo la igualdad. Primero restamos ${b} a ambos lados para eliminar la constante y obtenemos ${a}x = ${c-b}. Luego dividimos entre ${a} para aislar la inc√≥gnita: x = ${(c-b)}/${a} = ${ans}. Verificamos sustituyendo el valor en la ecuaci√≥n original y comprobando que ${a}¬∑${ans} + ${b} = ${c}. Este m√©todo funciona para cualquier ecuaci√≥n lineal y es la base de procedimientos m√°s complejos como sistemas de ecuaciones. Adem√°s, conviene revisar mentalmente que el resultado tenga sentido (por ejemplo, si ${a}x es un n√∫mero cercano a ${c}, x debe ser del orden de ${(c/a).toFixed(1)}).`;
    return {stem:`Si ${a}x + ${b} = ${c}, ¬øcu√°nto vale x?`, choices:opts, answerIndex:opts.indexOf(String(ans)), explain};
  }},
  {subject:"Matem√°ticas", topic:"√Ålgebra", difficulty:0.45, build:()=>{
    const x=randInt(1,9), y=randInt(1,9);
    const a=randInt(1,5), b=randInt(1,5), c=randInt(1,5), d=randInt(1,5);
    const s1=a*x + b*y, s2=c*x + d*y;
    const ask = sample(["x","y"]); const correct = (ask==="x")? x : y;
    const opts = shuffle([correct, correct+1, correct-1, correct+2]).map(String);
    const explain = `El sistema ${a}x + ${b}y = ${s1} y ${c}x + ${d}y = ${s2} fue construido para que su soluci√≥n exacta sea (x,y)=(${x},${y}). Puedes resolverlo por sustituci√≥n (despejando una variable y reemplaz√°ndola en la otra ecuaci√≥n) o por eliminaci√≥n (multiplicando y sumando/restando para anular una inc√≥gnita). Al resolverlo correctamente, obtendr√≠as ${ask} = ${correct}. Verificar reemplazando en ambas ecuaciones garantiza que no hubo errores de c√°lculo.`;
    return {stem:`Resuelve el sistema: ${a}x + ${b}y = ${s1}; ${c}x + ${d}y = ${s2}. ¬ø${ask}=?`, choices:opts, answerIndex:opts.indexOf(String(correct)), explain};
  }},
  {subject:"Matem√°ticas", topic:"Geometr√≠a", difficulty:0.30, build:()=>{
    const sets=[[3,4,5],[5,12,13],[6,8,10],[8,15,17],[9,12,15]]; const t=sample(sets);
    const [c1,c2,h]=t; const opts=shuffle([h,h+1,h-1,h+2]).map(String);
    const explain = `En tri√°ngulos rect√°ngulos, la hipotenusa se obtiene como la ra√≠z cuadrada de la suma de catetos al cuadrado: c = ‚àö(a¬≤ + b¬≤). Con a=${c1} y b=${c2}, c=‚àö(${c1*c1} + ${c2*c2}) = ${h}. Las ternas pitag√≥ricas como (${c1},${c2},${h}) simplifican el c√°lculo sin necesidad de calculadora y son √∫tiles para construir tri√°ngulos rectos en problemas geom√©tricos o de construcci√≥n.`;
    return { stem:`Tri√°ngulo rect√°ngulo con catetos ${c1} y ${c2}. ¬øHipotenusa?`, choices:opts, answerIndex:opts.indexOf(String(h)), explain };
  }},
  {subject:"Matem√°ticas", topic:"Probabilidad", difficulty:0.30, build:()=>{
    const ask=sample(["par","m√∫ltiplo de 3","mayor que 4"]);
    let correct; if(ask==="par") correct="1/2"; else if(ask==="m√∫ltiplo de 3") correct="1/3"; else correct="1/3";
    const opts=shuffle([correct,"1/6","2/3","5/6"]);
    const explain = `Con un dado justo hay 6 resultados equiprobables. Para ‚Äúpar‚Äù (2,4,6) hay 3 casos favorables ‚Üí 3/6 = 1/2. Para ‚Äúm√∫ltiplo de 3‚Äù (3,6) hay 2 casos ‚Üí 2/6 = 1/3. Para ‚Äúmayor que 4‚Äù (5,6) tambi√©n hay 2 casos ‚Üí 1/3. El enfoque correcto es identificar el espacio muestral, contar los casos favorables y simplificar la fracci√≥n; este razonamiento es la base de problemas m√°s complejos.`;
    return { stem:`Se lanza un dado. Probabilidad de obtener un n√∫mero ${ask}.`, choices:opts, answerIndex:opts.indexOf(correct), explain };
  }},
  {subject:"Matem√°ticas", topic:"Funciones", difficulty:0.40, build:()=>{
    const x1=randInt(-5,5), y1=randInt(-5,5), x2=randInt(1,9), y2=randInt(-5,5);
    const m = (y2 - y1) / (x2 - x1);
    const m2 = ((y2 - y1) + 1) / (x2 - x1);
    const m3 = (y2 - y1) / (x2 - x1 + 1);
    const opts = shuffle([m, m2, m3, m+1]).map(v=>String(Number(v.toFixed(2))));
    const correct = String(Number(m.toFixed(2)));
    const explain = `La pendiente mide el cambio vertical por unidad de cambio horizontal entre dos puntos. Con (${x1},${y1}) y (${x2},${y2}), m=(y‚ÇÇ‚àíy‚ÇÅ)/(x‚ÇÇ‚àíx‚ÇÅ) = ${correct}. Una pendiente positiva indica crecimiento; negativa, decrecimiento; cero, horizontal. Redondeamos a dos decimales para facilitar la lectura y comparamos con opciones cercanas para evitar confusiones.`;
    return { stem:`Pendiente de la recta que une (${x1},${y1}) y (${x2},${y2}).`, choices:opts, answerIndex:opts.indexOf(correct), explain };
  }},
  {subject:"Ciencias Naturales", topic:"Qu√≠mica", difficulty:0.35, build:()=>{
    const mol=randInt(1,3), L=randInt(1,3);
    const M = (mol/L).toFixed(2);
    const opts = shuffle([M, (mol/(L+1)).toFixed(2), (mol/(L+2)).toFixed(2), (mol/(L+0.5)).toFixed(2)]);
    const explain = `La molaridad cuantifica la concentraci√≥n como moles por litro: M=n/V. Si tenemos ${mol} moles en ${L} litros, M=${mol}/${L}=${M} M. Esta unidad permite escalar recetas qu√≠micas y calcular rendimientos. Por ejemplo, duplicar el volumen a igual n√∫mero de moles reduce a la mitad la concentraci√≥n, y viceversa.`;
    return { stem:`Una disoluci√≥n tiene ${mol} mol de soluto en ${L} L. ¬øMolaridad (M)?`, choices:opts, answerIndex:opts.indexOf(String(M)), explain };
  }},
  {subject:"Ciencias Naturales", topic:"Qu√≠mica", difficulty:0.40, build:()=>{
    const x=randInt(1,4), y=2*randInt(1,4); const o2=x+y/4;
    const opts=shuffle([o2, o2+0.5, o2-0.5, o2+1]).map(v=>String(v));
    const explain = `Al balancear la combusti√≥n de C${x}H${y} con ox√≠geno para formar CO‚ÇÇ y H‚ÇÇO, el coeficiente de O‚ÇÇ resulta de empatar √°tomos de O en productos: se necesitan x mol√©culas de CO‚ÇÇ (aportan 2x ox√≠genos) y y/2 mol√©culas de H‚ÇÇO (aportan y ox√≠genos), en total 2x + (y/2). Como cada O‚ÇÇ aporta 2 ox√≠genos, el coeficiente es (2x + y/2)/2 = x + y/4. Este atajo evita tanteos extensos.`;
    return { stem:`En la combusti√≥n de C${x}H${y}, ¬øcoeficiente de O‚ÇÇ al balancear?`, choices:opts, answerIndex:opts.indexOf(String(o2)), explain };
  }},
  {subject:"Ciencias Naturales", topic:"Biolog√≠a", difficulty:0.30, build:()=>{
    const pairs=[["Cloroplasto","Fotos√≠ntesis"],["Mitocondria","Respiraci√≥n celular"],["Ribosoma","S√≠ntesis de prote√≠nas"],["N√∫cleo","Almacena ADN"]];
    const [org,func]=sample(pairs); const wrong=shuffle(pairs.filter(p=>p[0]!==org).map(p=>p[1])).slice(0,3);
    const all=shuffle([func,...wrong]);
    const explain = `Cada org√°nulo cumple una funci√≥n espec√≠fica que garantiza el equilibrio celular. El ${org} se asocia a ‚Äú${func}‚Äù. Por ejemplo, los ribosomas leen el ARN mensajero para ensamblar prote√≠nas; la mitocondria convierte energ√≠a qu√≠mica de nutrientes en ATP; el n√∫cleo coordina la expresi√≥n gen√©tica y los cloroplastos transforman luz en glucosa y ox√≠geno. Distinguirlas facilita comprender procesos como crecimiento, reparaci√≥n y metabolismo.`;
    return { stem:`¬øCu√°l es la funci√≥n principal de ${org}?`, choices:all, answerIndex:all.indexOf(func), explain };
  }},
  {subject:"Ciencias Naturales", topic:"Ecolog√≠a", difficulty:0.28, build:()=>{
    const correct="Productores"; const opts=shuffle([correct,"Consumidores primarios","Descomponedores","Consumidores terciarios"]);
    const explain = `En una cadena tr√≥fica, los productores (plantas y algas) transforman energ√≠a solar en biomasa mediante fotos√≠ntesis, sirviendo de base energ√©tica para el resto de niveles. Los consumidores primarios se alimentan de ellos, y as√≠ sucesivamente. Reconocer el papel de los productores ayuda a entender el flujo de energ√≠a en los ecosistemas y las consecuencias de su disminuci√≥n.`;
    return { stem:`En una cadena tr√≥fica, ¬øqui√©nes capturan energ√≠a solar directamente?`, choices:opts, answerIndex:opts.indexOf(correct), explain };
  }},
  {subject:"Lectura Cr√≠tica", topic:"Idea principal", difficulty:0.35, build:()=>{
    const animals=[["abejas","polinizaci√≥n"],["manglares","costas"],["bosques urbanos","temperatura de ciudades"]];
    const [a,benef]=sample(animals);
    const p=`Los ${a} cumplen un papel clave; sin ellos, diversos sistemas se ven afectados. Estudios recientes muestran que su presencia favorece la ${benef}.`;
    const correct=`La presencia de ${a} es clave porque favorece la ${benef}.`;
    const opts=shuffle([correct,`El texto critica a los ${a}.`,`Los ${a} no influyen en la ${benef}.`,`Solo importan en laboratorios.`]);
    const explain = `La idea principal resume el mensaje global del pasaje, no un detalle menor. El texto establece el valor de los ${a} y su relaci√≥n positiva con la ${benef}, por lo que la opci√≥n correcta formula esa s√≠ntesis. Alternativas que niegan la influencia o atribuyen una cr√≠tica no reflejan el contenido ni el tono del fragmento.`;
    return { stem:`Lee: ‚Äú${p}‚Äù ¬øCu√°l es la idea principal?`, choices:opts, answerIndex:opts.indexOf(correct), explain };
  }},
  {subject:"Lectura Cr√≠tica", topic:"Conectores", difficulty:0.30, build:()=>{
    const s1="La ciudad invirti√≥ en ciclorrutas;"; const s2="___, el uso de la bicicleta aument√≥.";
    const correct="por ello"; const opts=shuffle([correct,"sin embargo","aunque","a pesar de"]);
    const explain = `Los conectores cohesionan ideas seg√∫n la relaci√≥n l√≥gica. Si la primera oraci√≥n expresa una causa (inversi√≥n en ciclorrutas), la segunda describe la consecuencia (aumento de uso). ‚ÄúPor ello‚Äù enlaza causa‚Äìefecto. ‚ÄúSin embargo‚Äù, ‚Äúaunque‚Äù y ‚Äúa pesar de‚Äù introducen contraste, lo que contradice el sentido del enunciado.`;
    return { stem:`Completa con el conector adecuado: "${s1} ${s2}"`, choices:opts, answerIndex:opts.indexOf(correct), explain };
  }},
  {subject:"Ingl√©s", topic:"Vocabulary", difficulty:0.30, build:()=>{
    const pairs=[["reliable","trustworthy"],["quick","rapid"],["smart","intelligent"],["tiny","small"],["brave","courageous"]];
    const [w,syn]=sample(pairs); const wrong=shuffle(pairs.filter(p=>p[0]!==w).map(p=>p[1])).slice(0,3);
    const all=shuffle([syn,...wrong]);
    const explain = `‚Äú${w}‚Äù y ‚Äú${syn}‚Äù comparten significado central en la mayor√≠a de contextos. Elegir sin√≥nimos exige evaluar cercan√≠a sem√°ntica y registro; por ejemplo, ‚Äúquick/rapid‚Äù denotan velocidad, mientras que ‚Äúreliable/trustworthy‚Äù aluden a confiabilidad. La opci√≥n correcta mantiene el matiz clave del enunciado.`;
    return { stem:`Choose the best synonym for ‚Äú${w}‚Äù.`, choices:all, answerIndex:all.indexOf(syn), explain };
  }},
  {subject:"Ingl√©s", topic:"Reading", difficulty:0.35, build:()=>{
    const place=sample(["the library","the park","the museum"]);
    const p=`Tom visits ${place} on weekends to study and relax. He prefers quiet places.`;
    const correct="He likes quiet places.";
    const opts=shuffle([correct,"He hates weekends","He works there","He never studies"]);
    const explain = `Del texto inferimos preferencias del personaje: ‚Äúprefers quiet places‚Äù implica que le gustan los lugares tranquilos, por eso la opci√≥n correcta sintetiza esa informaci√≥n impl√≠cita/explicita. Las otras alternativas contradicen el pasaje o a√±aden datos no mencionados.`;
    return { stem:`Read: ‚Äú${p}‚Äù What can we infer?`, choices:opts, answerIndex:opts.indexOf(correct), explain };
  }},
  {subject:"Sociales", topic:"Historia de Colombia", difficulty:0.35, build:()=>{
    const items=[["1810","inicio proceso de independencia"],["1819","batalla decisiva de Boyac√°"],["1821","Constituci√≥n de C√∫cuta/Gran Colombia"]];
    const [anio,desc]=sample(items);
    const correct=anio; const opts=shuffle([anio, ...shuffle(items.filter(i=>i[0]!==anio).map(i=>i[0])).slice(0,3)]);
    const explain = `Asociar fechas con eventos permite ordenar procesos hist√≥ricos. El hito ‚Äú${desc}‚Äù corresponde a ${anio}, dentro de la secuencia que va del inicio del proceso emancipador a su consolidaci√≥n pol√≠tico-institucional. Esta vinculaci√≥n temporal ayuda a contextualizar causas y consecuencias.`;
    return { stem:`¬øQu√© a√±o se asocia principalmente con: ${desc}?`, choices:opts, answerIndex:opts.indexOf(correct), explain };
  }},
  {subject:"Sociales", topic:"Geograf√≠a", difficulty:0.28, build:()=>{
    const correct="Magdalena"; const opts=shuffle([correct,"Cauca","Putumayo","Orinoco"]);
    const explain = `El Magdalena es el r√≠o m√°s largo de Colombia y eje hist√≥rico del transporte fluvial y del poblamiento. Conocer su primac√≠a facilita interpretar mapas, redes comerciales y din√°micas ambientales. Otras cuencas son claves regionalmente, pero no superan su longitud en el territorio nacional.`;
    return { stem:`¬øCu√°l es el r√≠o m√°s largo de Colombia?`, choices:opts, answerIndex:opts.indexOf(correct), explain };
  }}
];

/* ================== PERFILES, THEME, PUNTOS ================== */
function setTheme(u){ document.documentElement.setAttribute('data-theme', u); }
function pointsKey(u){ return `points:${u}`; }
function getPoints(u){ return parseInt(localStorage.getItem(pointsKey(u))||"0",10); }
function addPoints(u,delta){ const p=getPoints(u)+delta; localStorage.setItem(pointsKey(u), String(p)); return p; }
function setActiveUser(u){ localStorage.setItem("activeUser", u); setTheme(u); }
function getActiveUser(){ return localStorage.getItem("activeUser") || null; }

/* ================== PIN (contrase√±a) ================== */
function pinKey(u){ return `pin:${u}`; }
function getPIN(u){ return localStorage.getItem(pinKey(u)); }
function setPIN(u,pin){ localStorage.setItem(pinKey(u), pin); }
function enterWithPIN(user, inputId){
  const typed = $( '#'+inputId ).value.trim();
  if(typed.length!==4){ alert("PIN de 4 d√≠gitos"); return; }
  const saved = getPIN(user);
  if(!saved){ setPIN(user, typed); } else if(saved!==typed){ alert("PIN incorrecto"); return; }
  setActiveUser(user);
  $("#loginView").classList.add("hidden");
  $("#appView").classList.remove("hidden");
  $("#who").textContent = user;
  renderHomeScores();
  initStudy();
  initPracticeSelectors();
  showSection('study');
}

/* ================== NAVEGACI√ìN ================== */
const sections = { study:"#studyView", practice:"#practiceView", exam:"#examView", daily:"#dailyView", history:"#historyView", badges:"#badgesView"};
function showSection(name){
  for(const k in sections){ const el=$(sections[k]); (k===name)?el.classList.remove("hidden"):el.classList.add("hidden"); }
  $("#navStudy").classList.toggle("active", name==='study');
  $("#navPractice").classList.toggle("active", name==='practice');
  $("#navExam").classList.toggle("active", name==='exam');
  $("#navDaily").classList.toggle("active", name==='daily');
  $("#navHistory").classList.toggle("active", name==='history');
  $("#navBadges").classList.toggle("active", name==='badges');
}
$("#navStudy").onclick = ()=>showSection('study');
$("#navPractice").onclick = ()=>{ showSection('practice'); nextQuestion(); };
$("#navExam").onclick = ()=>showSection('exam');
$("#navDaily").onclick = ()=>showDaily();
$("#navHistory").onclick = ()=>showHistory();
$("#navBadges").onclick = ()=>renderBadges();
function logout(){ localStorage.removeItem("activeUser"); $("#appView").classList.add("hidden"); $("#loginView").classList.remove("hidden"); renderHomeScores(); }
function renderHomeScores(){ $("#albaPoints").textContent=getPoints("Alba"); $("#laraPoints").textContent=getPoints("Lara"); $("#albaBadgesCount").textContent=getAllBadges("Alba").length; $("#laraBadgesCount").textContent=getAllBadges("Lara").length; }

/* ================== SUBJECT/TOPIC helpers ================== */
function subjects(){
  const s1=new Set(FIXED_QUESTIONS.map(q=>q.subject));
  const s2=new Set(TEMPLATES.map(t=>t.subject));
  const s3=new Set(Object.keys(STUDY));
  return [...new Set([...s1,...s2,...s3])].sort();
}
function topics(subject){
  const t1 = FIXED_QUESTIONS.filter(q=>q.subject===subject).map(q=>q.topic);
  const t2 = TEMPLATES.filter(t=>t.subject===subject).map(t=>t.topic);
  const t3 = Object.keys(STUDY[subject]||{});
  return [...new Set([...t1,...t2,...t3])].sort();
}

/* ================== STUDY ================== */
function initStudy(){
  const ss=$("#studySubject"), ts=$("#studyTopic");
  ss.innerHTML = subjects().map(s=>`<option>${s}</option>`).join('');
  ss.onchange = ()=>{ ts.innerHTML = topics(ss.value).map(t=>`<option>${t}</option>`).join(''); renderStudy(); };
  ts.onchange = renderStudy;
  ss.dispatchEvent(new Event('change'));
  $("#studyPractice").onclick = ()=>{
    $("#subject").value = ss.value;
    $("#topic").value = ts.value;
    showSection('practice');
    nextQuestion();
  };
  renderStudy();
}
function renderStudy(){
  const s=$("#studySubject").value, t=$("#studyTopic").value;
  const block = STUDY[s] && STUDY[s][t];
  const sc=$("#studyContent"), ex=$("#studyExamples"), sq=$("#studyQ");
  if(!block){ sc.innerHTML="(No hay contenido todav√≠a)"; ex.classList.add("hidden"); sq.classList.add("hidden"); return; }
  sc.innerHTML = block.theory || "(sin teor√≠a)";
  if(block.examples && block.examples.length){
    ex.classList.remove("hidden");
    ex.innerHTML = `<h4>Ejemplos resueltos</h4>` + block.examples.map(e=>`<div class="card"><b>${e.title}</b><ol class="small">${e.steps.map(s=>`<li>${s}</li>`).join('')}</ol></div>`).join('');
  }else ex.classList.add("hidden");
  const g=block.guided && block.guided();
  if(g){
    sq.classList.remove("hidden");
    $("#studyStem").textContent = g.stem;
    const box=$("#studyOpts"); box.innerHTML="";
    g.choices.forEach((ch,i)=>{
      const b=document.createElement('button');
      b.className='option'; b.textContent=ch;
      b.onclick = ()=>{
        [...box.children].forEach((el,idx)=>{
          el.disabled=true;
          if(idx===g.answerIndex) el.classList.add('correct');
          if(idx===i && i!==g.answerIndex) el.classList.add('incorrect');
        });
        $("#studyResult").textContent = (i===g.answerIndex)?"‚úÖ ¬°Correcto!":"‚ùå Incorrecto";
        $("#studyResult").className = "result " + ((i===g.answerIndex)?"good":"bad");
        $("#studyResult").classList.remove("hidden");
        $("#studyExplain").textContent = g.explain||"";
        $("#studyExplain").classList.remove("hidden");
      };
      box.appendChild(b);
    });
    $("#studyResult").classList.add("hidden"); $("#studyExplain").classList.add("hidden");
  } else {
    sq.classList.add("hidden");
  }
}

/* ================== PRACTICE ================== */
const subjectSel = $("#subject"), topicSel=$("#topic");
let current=null;

function initPracticeSelectors(){
  subjectSel.innerHTML = subjects().map(s=>`<option>${s}</option>`).join('');
  subjectSel.onchange = ()=>{ topicSel.innerHTML = topics(subjectSel.value).map(t=>`<option>${t}</option>`).join(''); onTopicChange(); };
  topicSel.onchange = onTopicChange;
  subjectSel.dispatchEvent(new Event('change'));
  $("#reset").onclick = ()=>{
    const u=getActiveUser(), s=subjectSel.value, t=topicSel.value;
    if(confirm(`¬øBorrar progreso de ${u} en ${s}/${t}?`)){
      localStorage.removeItem(abilityKey(u,s,t));
      localStorage.removeItem(statsKey(u,s,t));
      renderStats(u,s,t); nextQuestion();
    }
  };
}
function onTopicChange(){ const u=getActiveUser(), s=subjectSel.value, t=topicSel.value; renderStats(u,s,t); nextQuestion(); }

function renderStats(u,subject,topic){
  const st=statsGet(u,subject,topic), ability=abilityGet(u,subject,topic);
  $("#stats").innerHTML = `
    <span class="pill">Usuario: <b>${u}</b></span>
    <span class="pill">Aciertos: <b>${st.right}</b></span>
    <span class="pill">Errores: <b>${st.wrong}</b></span>
    <span class="pill">Vistas: <b>${st.seen}</b></span>
    <span class="pill">Nivel: <b>${ability.toFixed(2)}</b></span>
    <span class="pill">Puntos: <b>${getPoints(u)}</b></span>
  `;
}
function bankBy(subject,topic){
  return FIXED_QUESTIONS.filter(q=>q.subject===subject && q.topic===topic);
}
function templatesBy(subject,topic){
  return TEMPLATES.filter(t=>t.subject===subject && t.topic===topic);
}
function buildFromTemplate(subject,topic){
  const c=templatesBy(subject,topic); if(c.length){ const t=sample(c); const b=t.build(); return { id:`gen-${subject}-${topic}-${Date.now()}-${Math.floor(Math.random()*1e6)}`, subject, topic, difficulty:t.difficulty, stem:b.stem, choices:b.choices, answerIndex:b.answerIndex, explain:b.explain, generated:true }; }
  const any = TEMPLATES.filter(t=>t.subject===subject);
  if(any.length){ const t=sample(any); const b=t.build(); return { id:`gen-${subject}-${t.topic}-${Date.now()}-${Math.floor(Math.random()*1e6)}`, subject, topic:t.topic, difficulty:t.difficulty, stem:b.stem, choices:b.choices, answerIndex:b.answerIndex, explain:b.explain, generated:true, fallback:true }; }
  const t=sample(TEMPLATES); const b=t.build(); return { id:`gen-${t.subject}-${t.topic}-${Date.now()}-${Math.floor(Math.random()*1e6)}`, subject:t.subject, topic:t.topic, difficulty:t.difficulty, stem:b.stem, choices:b.choices, answerIndex:b.answerIndex, explain:b.explain, generated:true, fallback:true };
}
function pickNext(u,subject,topic){
  const ability = abilityGet(u,subject,topic);
  let useTemplate = true;
  if(useTemplate){ const g=buildFromTemplate(subject,topic); if(g) return g; }
  const bank=bankBy(subject,topic);
  if(!bank.length) return buildFromTemplate(subject,topic);
  let best=null, gap=1e9;
  for(const q of bank){ const g=Math.abs((q.difficulty??0.3)-ability); if(g<gap){ best=q; gap=g; } }
  return {...best};
}
function renderQuestion(q){
  $("#meta").textContent = `${q.subject} ‚Ä¢ ${q.topic} ‚Ä¢ dif ${(q.difficulty??0.3).toFixed(2)}${q.generated?' ‚Ä¢ generada':''}${q.fallback?' ‚Ä¢ (sugerido)':''}`;
  $("#question").textContent = q.stem;
  $("#result").className = "result hidden"; $("#result").textContent="";
  $("#similar").classList.add("hidden");
  $("#next").classList.add("hidden");
  const opts=$("#options"); opts.innerHTML="";
  $("#explanation").classList.add("hidden"); $("#explanation").innerHTML="";
  current=q;
  q.choices.forEach((ch,i)=>{
    const b=document.createElement('button');
    b.type="button"; b.className='option'; b.textContent=ch;
    b.addEventListener('click', ()=>selectOption(i), {once:true});
    opts.appendChild(b);
  });
}
function nextQuestion(){
  const u=getActiveUser(), s=subjectSel.value, t=topicSel.value;
  const q = pickNext(u,s,t); renderQuestion(q);
}
$("#similar").onclick = ()=>{
  const s=subjectSel.value, t=subjectSel.value?topicSel.value:null;
  const g=buildFromTemplate(s, t||"");
  renderQuestion(g);
};
$("#next").onclick = nextQuestion;

function abilityKey(u,s,t){ return `ability:${u}:${s}:${t}`; }
function statsKey(u,s,t){ return `stats:${u}:${s}:${t}`; }
function abilityGet(u,s,t){ const v=localStorage.getItem(abilityKey(u,s,t)); return v?parseFloat(v):0.30; }
function abilitySet(u,s,t,val){ localStorage.setItem(abilityKey(u,s,t), String(clamp(val,0.05,0.95))); }
function statsGet(u,s,t){ const v=localStorage.getItem(statsKey(u,s,t)); return v?JSON.parse(v):{seen:0,right:0,wrong:0}; }
function statsSet(u,s,t,st){ localStorage.setItem(statsKey(u,s,t), JSON.stringify(st)); }

function selectOption(index){
  const u=getActiveUser(), s=subjectSel.value, t=topicSel.value;
  const correct = index===current.answerIndex;
  [...$("#options").children].forEach((el,i)=>{
    el.disabled=true;
    if(i===current.answerIndex) el.classList.add('correct');
    if(i===index && !correct) el.classList.add('incorrect');
    if(i===index && correct) el.classList.add('correct');
  });
  const st=statsGet(u,s,t); st.seen += 1; correct ? st.right++ : st.wrong++; statsSet(u,s,t,st);
  let ab=abilityGet(u,s,t); ab += correct ? 0.05 : -0.07; abilitySet(u,s,t,ab);
  const delta = correct ? 10 : 0; addPoints(u, delta);
  trackHistory(u, s, t, correct);
  checkStreak(u, correct);
  renderStats(u,s,t);
  $("#result").textContent = correct ? "‚úÖ ¬°Correcto!" : "‚ùå Incorrecto";
  $("#result").className = "result " + (correct ? "good" : "bad");
  $("#explanation").innerHTML = `<div>${current.explain??''}</div>`;
  $("#explanation").classList.remove("hidden");
  $("#similar").classList.remove("hidden");
  $("#next").classList.remove("hidden");
  if(!correct){ $("#similar").classList.add("accent"); $("#next").classList.remove("accent"); }
  else { $("#similar").classList.remove("accent"); $("#next").classList.add("accent"); }
  evaluateBadges(u);
}

/* ================== EXAM ================== */
let exam = null, timerId=null;
function startExam(){
  const count=parseInt($("#examCount").value,10);
  const minutes=parseInt($("#examMinutes").value,10);
  const poolSubjects = subjects();
  const qs=[];
  for(let i=0;i<count;i++){
    const sub = sample(poolSubjects);
    const tops = topics(sub);
    const top = sample(tops);
    const g=buildFromTemplate(sub, top);
    qs.push(g);
  }
  exam = { items: qs, answers: Array(qs.length).fill(null), idx: 0, seconds: minutes*60 };
  $("#examTotal").textContent = String(qs.length);
  renderExamQuestion();
  $("#examCard").classList.remove("hidden");
  $("#examSummary").classList.add("hidden");
  startTimer();
}
function renderExamQuestion(){
  const i=exam.idx, q=exam.items[i];
  $("#examIndex").textContent = String(i+1);
  $("#examQ").textContent = q.stem;
  const box=$("#examOptions"); box.innerHTML="";
  q.choices.forEach((ch,ci)=>{
    const b=document.createElement('button');
    b.type="button"; b.className='option'; b.textContent=ch;
    const chosen = exam.answers[i]===ci;
    if(chosen) b.classList.add('correct');
    b.onclick = ()=>{ exam.answers[i]=ci; renderExamQuestion(); };
    box.appendChild(b);
  });
  $("#examPrev").onclick = ()=>{ if(exam.idx>0){ exam.idx--; renderExamQuestion(); } };
  $("#examNext").onclick = ()=>{ if(exam.idx<exam.items.length-1){ exam.idx++; renderExamQuestion(); } };
}
function startTimer(){ stopTimer(); $("#examTimer").textContent = fmtTime(exam.seconds); timerId = setInterval(()=>{ exam.seconds--; $("#examTimer").textContent = fmtTime(exam.seconds); if(exam.seconds<=0){ finishExam(); } },1000); }
function stopTimer(){ if(timerId){ clearInterval(timerId); timerId=null; } }
function finishExam(){
  stopTimer();
  const u=getActiveUser();
  let correct=0;
  const list=$("#sumList"); list.innerHTML="";
  exam.items.forEach((q,i)=>{
    const chosen = exam.answers[i];
    const ok = chosen===q.answerIndex;
    if(ok) correct++;
    const li=document.createElement('li');
    const letter = idx=>["A","B","C","D"][idx] || (idx+1);
    li.innerHTML = `<div><b>${i+1}.</b> ${q.stem}</div>
      <div class="small ${ok?'good':'bad'}">Tu respuesta: ${chosen==null?'<i>No respondida</i>':letter(chosen)} ‚Äî Correcta: ${letter(q.answerIndex)}</div>
      <div class="small muted" style="margin-left:8px">${q.explain||''}</div>`;
    list.appendChild(li);
  });
  $("#sumCorrect").textContent = String(correct);
  $("#sumTotal").textContent = String(exam.items.length);
  const points = correct*10;
  $("#sumScore").textContent = String(points);
  addPoints(u, points);
  trackHistory(u, "Simulador", "Mixto", null, correct, exam.items.length);
  evaluateBadges(u, true, correct===exam.items.length);
  $("#examSummary").classList.remove("hidden");
}

/* ================== RETO DIARIO ================== */
let daily=null;
function dailyKey(u){ return `daily:${u}:${todayKey()}`; }
function hasDaily(u){ return localStorage.getItem(dailyKey(u))==="done"; }
function startDaily(){
  const u=getActiveUser();
  if(hasDaily(u)){ showDaily(); return; }
  const qs=[]; const poolSubjects=subjects();
  for(let i=0;i<10;i++){
    const sub=sample(poolSubjects); const top=sample(topics(sub));
    const g=buildFromTemplate(sub, top);
    qs.push(g);
  }
  daily = { items:qs, idx:0, wrong:false };
  $("#dailyStart").classList.add("hidden");
  $("#dailyDone").classList.add("hidden");
  $("#dailyCard").classList.remove("hidden");
  renderDaily();
}
function renderDaily(){
  const q=daily.items[daily.idx];
  $("#dailyIndex").textContent = String(daily.idx+1);
  $("#dailyQ").textContent = q.stem;
  const box=$("#dailyOptions"); box.innerHTML="";
  $("#dailyResult").className="result hidden"; $("#dailyExplain").classList.add("hidden"); $("#dailyExplain").textContent="";
  q.choices.forEach((ch,i)=>{
    const b=document.createElement('button');
    b.className='option'; b.textContent=ch;
    b.onclick = ()=>{
      const ok = i===q.answerIndex;
      if(!ok) daily.wrong=true;
      [...box.children].forEach((el,idx)=>{
        el.disabled=true;
        if(idx===q.answerIndex) el.classList.add('correct');
        if(idx===i && !ok) el.classList.add('incorrect');
        if(idx===i && ok) el.classList.add('correct');
      });
      $("#dailyResult").textContent = ok ? "‚úÖ ¬°Correcto!" : "‚ùå Incorrecto";
      $("#dailyResult").className = "result " + (ok ? "good" : "bad");
      $("#dailyExplain").textContent = q.explain || "";
      $("#dailyExplain").classList.remove("hidden");
    };
    box.appendChild(b);
  });
  $("#dailyNext").onclick = ()=>{
    if(daily.idx < daily.items.length-1){ daily.idx++; renderDaily(); }
    else {
      const u=getActiveUser();
      localStorage.setItem(dailyKey(u),"done");
      const gained = daily.wrong? (10*daily.items.length) : (20*daily.items.length);
      addPoints(u, gained);
      trackHistory(u, "Reto diario", "Mixto", null, daily.items.length - (daily.wrong?1:0), daily.items.length);
      evaluateBadges(u, false, !daily.wrong);
      showDaily();
    }
  };
}
function showDaily(){
  const u=getActiveUser();
  $("#dailyCard").classList.add("hidden");
  $("#dailyStart").classList.toggle("hidden", hasDaily(u));
  $("#dailyDone").classList.toggle("hidden", !hasDaily(u));
  showSection('daily');
}

/* ================== HISTORIAL ================== */
function histKey(u){ return `history:${u}`; }
function getHistory(u){ return JSON.parse(localStorage.getItem(histKey(u))||"[]"); }
function pushHistory(u, rec){ const h=getHistory(u); h.push(rec); localStorage.setItem(histKey(u), JSON.stringify(h.slice(-200))); }
function trackHistory(u, subject, topic, correct=null, correctCount=0, total=1){
  const rec = { date: new Date().toISOString(), subject, topic, correct, correctCount, total };
  pushHistory(u, rec);
}
function showHistory(){
  const u=getActiveUser(); const h=getHistory(u);
  const list=$("#histList"); list.innerHTML = h.slice(-20).reverse().map(r=>{
    const d=new Date(r.date); const dd=d.toLocaleString();
    const label = (r.correct===null) ? `Examen/Reto: ${r.correctCount}/${r.total}` : (r.correct ? "‚úîÔ∏è" : "‚úñÔ∏è");
    return `<li>${dd} ‚Äî <b>${r.subject}</b> / ${r.topic} ‚Äî ${label}</li>`;
  }).join('');
  const daily = {};
  for(const r of h){
    const day = r.date.slice(0,10);
    if(!daily[day]) daily[day]={correct:0,total:0};
    daily[day].correct += (r.correct===null? r.correctCount : (r.correct?1:0));
    daily[day].total   += (r.correct===null? r.total : 1);
  }
  const days = Object.keys(daily).sort().slice(-7);
  const data = days.map(d=>({day:d, acc: daily[d].total? (daily[d].correct/daily[d].total)*100 : 0}));
  drawChart($("#histChart"), data);
  showSection('history');
}
function drawChart(canvas, data){
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const pad=30, w=canvas.width, h=canvas.height, cw=w-pad*2, ch=h-pad*2;
  ctx.strokeStyle="#ccc"; ctx.fillStyle="#000"; ctx.font="12px system-ui";
  ctx.beginPath(); ctx.moveTo(pad,pad); ctx.lineTo(pad,h-pad); ctx.lineTo(w-pad,h-pad); ctx.stroke();
  const bw = cw / Math.max(1,data.length);
  data.forEach((d,i)=>{
    const x=pad + i*bw + bw*0.15;
    const val = d.acc; const bh = (val/100)*ch;
    ctx.fillStyle = getActiveUser()==="Alba" ? "#e91e63" : "#7e57c2";
    ctx.fillRect(x, h-pad-bh, bw*0.7, bh);
    ctx.fillStyle="#000"; ctx.fillText(String(Math.round(val))+"%", x, h-pad-bh-4);
    ctx.fillText(d.day.slice(5), x, h-pad+14);
  });
}

/* ================== MEDALLAS ================== */
const BADGE_LIST = [
  {id:"streak10", name:"Racha 10", desc:"10 aciertos seguidos en pr√°ctica."},
  {id:"hundredQs", name:"Centenaria", desc:"100 preguntas contestadas (en pr√°ctica)."},
  {id:"mathMax", name:"Nivel top Mate", desc:"Nivel ‚â• 0.80 en Matem√°ticas/√Ålgebra."},
  {id:"perfectExam", name:"Examen perfecto", desc:"Simulador con 100% correctas."},
  {id:"dailyPerfect", name:"Reto perfecto", desc:"Reto diario sin errores."}
];
function badgesKey(u){ return `badges:${u}`; }
function getAllBadges(u){ return JSON.parse(localStorage.getItem(badgesKey(u))||"[]"); }
function awardBadge(u,id){ const b=getAllBadges(u); if(!b.includes(id)){ b.push(id); localStorage.setItem(badgesKey(u), JSON.stringify(b)); } }
let streak=0;
function checkStreak(u, correct){
  streak = correct ? streak+1 : 0;
  if(streak>=10) awardBadge(u,"streak10");
  const total = Object.keys(localStorage).filter(k=>k.startsWith(`stats:${u}:`)).map(k=>JSON.parse(localStorage.getItem(k)).seen||0).reduce((a,b)=>a+b,0);
  if(total>=100) awardBadge(u,"hundredQs");
  const level = abilityGet(u,"Matem√°ticas","√Ålgebra");
  if(level>=0.80) awardBadge(u,"mathMax");
}
function evaluateBadges(u, fromExam=false, perfect=false){
  if(fromExam && perfect) awardBadge(u,"perfectExam");
  if(!fromExam && perfect) awardBadge(u,"dailyPerfect");
}
function renderBadges(){
  const u=getActiveUser(); const owned=new Set(getAllBadges(u));
  $("#badgesBox").innerHTML = BADGE_LIST.map(b=>{
    const has=owned.has(b.id);
    return `<span class="badge" style="${has?'':'opacity:.4'}">üèÖ <b>${b.name}</b> ‚Äî ${b.desc}</span>`;
  }).join('');
  showSection('badges');
}

/* ================== INICIO ================== */
(function start(){
  const u=getActiveUser();
  setTheme(u||"Alba");
  renderHomeScores();
  if(u){
    $("#loginView").classList.add("hidden");
    $("#appView").classList.remove("hidden");
    $("#who").textContent=u;
    initStudy();
    initPracticeSelectors();
    showSection('study');
  } else {
    $("#loginView").classList.remove("hidden");
    $("#appView").classList.add("hidden");
  }
})();
</script>

<div class="small muted" style="margin-top:16px">
  Hecho para pr√°ctica personal de Saber 11 ‚Äî Explicaciones ampliadas (m√≠n. 1 p√°rrafo). Preguntas generadas/parametrizadas, sin copiar bancos con copyright.
</div>
</body>
</html>
