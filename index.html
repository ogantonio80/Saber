<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Saber 11 ‚Äî Alba & Lara (Estudio ‚Ä¢ Pr√°ctica ‚Ä¢ Simulador)</title>
<style>
  :root{
    --bg:#ffffff;--card:#ffffff;--muted:#666;--border:#ddd;
    --ok:#1e7d32;--okbg:#d9fdd3;--bad:#c62828;--badbg:#fde8e8;
    --accent:#1a73e8;--accentText:#fff;
  }
  [data-theme="Alba"]{ --accent:#e91e63; --accentText:#fff; }
  [data-theme="Lara"]{ --accent:#7e57c2; --accentText:#fff; }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;margin:16px;max-width:980px;background:var(--bg)}
  h1,h2{margin:.2em 0}
  .card{border:1px solid var(--border);border-radius:12px;padding:16px;margin:12px 0;background:var(--card);box-shadow:0 1px 0 rgba(0,0,0,.02)}
  .muted{color:var(--muted)}
  .small{font-size:12px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .col{display:flex;flex-direction:column;gap:6px}
  button,select,input{font-size:16px;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
  button.accent{background:var(--accent);color:var(--accentText);border-color:var(--accent)}
  .option{display:block;width:100%;text-align:left;margin:8px 0;padding:12px;border:1px solid #ccc;border-radius:10px;cursor:pointer;background:#fafafa;transition:background .2s,border-color .2s,transform .05s}
  .option:active{transform:scale(0.99)}
  .option.correct{border-color:var(--ok);background:var(--okbg)}
  .option.incorrect{border-color:var(--bad);background:var(--badbg)}
  .pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:4px 10px;margin-right:8px;font-size:12px}
  .hidden{display:none}
  header.appbar{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;margin:8px 0 16px}
  header.appbar .spacer{flex:1}
  .result{margin-top:8px;font-weight:700}
  .result.good{color:var(--ok)}
  .result.bad{color:var(--bad)}
  .score{font-weight:700;color:#111}
  .grid{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
  .timer{font-weight:700}
  .list{list-style:none;padding-left:0;margin:0}
  .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;margin:4px 6px 0 0}
  .nav{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .nav button{border-color:var(--accent);color:var(--accent);background:#fff}
  .nav button.active{background:var(--accent);color:var(--accentText)}
  .title{display:flex;align-items:center;gap:8px}
  .title .chip{background:var(--accent);color:var(--accentText);border-radius:999px;padding:4px 10px;font-size:12px}
  canvas{max-width:100%}
</style>
</head>
<body>
<section id="loginView" class="card">
  <h1>üëã Hola</h1>
  <p>Elige qui√©n va a practicar hoy y escribe su clave (PIN de 4 d√≠gitos).</p>
  <div class="grid">
    <div class="card">
      <div class="title"><h2>Alba</h2><span class="chip">Rosa</span></div>
      <div class="muted small">Puntos: <span id="albaPoints" class="score">0</span> ¬∑ Medallas: <span id="albaBadgesCount">0</span></div>
      <div class="row">
        <input id="pinAlba" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="PIN (4 d√≠gitos)">
        <button class="accent" onclick="enterWithPIN('Alba', 'pinAlba')">Entrar</button>
      </div>
      <div class="small muted">Primer uso: el PIN que escribas quedar√° guardado.</div>
    </div>
    <div class="card">
      <div class="title"><h2>Lara</h2><span class="chip">Morado</span></div>
      <div class="muted small">Puntos: <span id="laraPoints" class="score">0</span> ¬∑ Medallas: <span id="laraBadgesCount">0</span></div>
      <div class="row">
        <input id="pinLara" inputmode="numeric" pattern="[0-9]*" maxlength="4" placeholder="PIN (4 d√≠gitos)">
        <button class="accent" onclick="enterWithPIN('Lara', 'pinLara')">Entrar</button>
      </div>
      <div class="small muted">Primer uso: el PIN que escribas quedar√° guardado.</div>
    </div>
  </div>
</section>

<section id="appView" class="hidden">
  <header class="appbar">
    <div><b>Usuario:</b> <span id="who"></span></div>
    <div class="spacer"></div>
    <div class="nav">
      <button id="navStudy" class="active">Estudio</button>
      <button id="navPractice">Pr√°ctica</button>
      <button id="navExam">Simulador</button>
      <button id="navDaily">Reto diario</button>
      <button id="navHistory">Historial</button>
      <button id="navBadges">Medallas</button>
    </div>
    <div class="spacer"></div>
    <button onclick="logout()">Cerrar sesi√≥n</button>
  </header>

  <!-- ===== STUDY ===== -->
  <section id="studyView" class="card">
    <h2>üìö Estudio</h2>
    <div class="row">
      <div class="col">
        <label class="small">Asignatura</label>
        <select id="studySubject"></select>
      </div>
      <div class="col">
        <label class="small">√Årea</label>
        <select id="studyArea"></select>
      </div>
      <div class="col">
        <label class="small">Tema</label>
        <select id="studyTopic"></select>
      </div>
      <div class="spacer"></div>
      <div class="col">
        <label class="small">Acciones</label>
        <div class="row">
          <button id="studyPractice" class="accent">Practicar este tema</button>
          <button id="studyNextTopic">Siguiente tema ‚ñ∂</button>
        </div>
      </div>
    </div>
    <div id="studyContent" class="card" style="background:#f9fafc"></div>
    <div id="studyExamples" class="card hidden"></div>
    <div id="studyQs" class="card hidden">
      <div class="muted small">Preguntas de estudio</div>
      <div id="studyQA"></div>
    </div>
  </section>

  <!-- ===== PRACTICE ===== -->
  <section id="practiceView" class="card hidden">
    <h2>üìù Pr√°ctica</h2>
    <div class="row">
      <div class="col">
        <label class="small">Asignatura</label>
        <select id="pSubject"></select>
      </div>
      <div class="col">
        <label class="small">√Årea</label>
        <select id="pArea"></select>
      </div>
      <div class="col">
        <label class="small">Tema</label>
        <select id="pTopic"></select>
      </div>
      <div class="spacer"></div>
      <div class="col">
        <label class="small">Acciones</label>
        <div class="row">
          <button id="reset">Reiniciar progreso (tema)</button>
          <button id="skipTopic">Saltar a otro tema</button>
        </div>
      </div>
    </div>
    <div id="stats" class="muted small" style="margin-top:8px"></div>
    <hr>
    <div id="meta" class="muted small" style="margin-bottom:8px"></div>
    <div id="question" style="font-size:18px;font-weight:600"></div>
    <div id="result" class="result hidden"></div>
    <div id="options"></div>
    <div id="explanation" class="card hidden" style="background:#f9fafc"></div>
    <div class="row" style="margin-top:8px">
      <button id="similar" class="hidden">Similar (autom√°tica)</button>
      <button id="next" class="accent hidden">Siguiente pregunta</button>
    </div>
  </section>

  <!-- ===== EXAM ===== -->
  <section id="examView" class="card hidden">
    <h2>Simulador Saber 11</h2>
    <div class="row">
      <div class="col">
        <label class="small">Cantidad</label>
        <select id="examCount">
          <option value="45" selected>45</option>
          <option value="30">30</option>
          <option value="60">60</option>
        </select>
      </div>
      <div class="col">
        <label class="small">Tiempo</label>
        <select id="examMinutes">
          <option value="90" selected>90 min</option>
          <option value="60">60 min</option>
          <option value="45">45 min</option>
        </select>
      </div>
      <div class="col" style="align-self:flex-end">
        <button class="accent" onclick="startExam()">Comenzar</button>
      </div>
    </div>
    <p class="small muted">Durante el examen no sabr√°s si aciertas; al final ver√°s el resumen con explicaciones.</p>
    <section id="examCard" class="card hidden">
      <div class="row">
        <div><b>Pregunta</b> <span id="examIndex">1</span>/<span id="examTotal">45</span></div>
        <div class="spacer"></div>
        <div class="timer">‚è± <span id="examTimer">90:00</span></div>
      </div>
      <div id="examQ" style="font-size:18px;font-weight:600;margin-top:6px"></div>
      <div id="examOptions"></div>
      <div class="row" style="margin-top:8px">
        <button id="examPrev">Anterior</button>
        <button id="examNext" class="accent">Siguiente</button>
        <div class="spacer"></div>
        <button onclick="finishExam()" class="accent">Finalizar</button>
      </div>
    </section>
    <section id="examSummary" class="card hidden">
      <h3>Resultados</h3>
      <p><b>Correctas:</b> <span id="sumCorrect">0</span> / <span id="sumTotal">0</span> ‚Äî <b>Puntos:</b> <span id="sumScore">0</span></p>
      <ol id="sumList" class="list"></ol>
    </section>
  </section>

  <!-- ===== DAILY CHALLENGE ===== -->
  <section id="dailyView" class="card hidden">
    <h2>üî• Reto diario</h2>
    <p class="small muted">10 preguntas mixtas. Completar sin fallos da <b>puntuaci√≥n doble</b>.</p>
    <div id="dailyCard" class="card hidden">
      <div><b>Pregunta</b> <span id="dailyIndex">1</span>/10</div>
      <div id="dailyQ" style="font-size:18px;font-weight:600;margin-top:6px"></div>
      <div id="dailyOptions"></div>
      <div id="dailyResult" class="result hidden"></div>
      <div id="dailyExplain" class="small muted hidden"></div>
      <div class="row" style="margin-top:8px">
        <button id="dailyNext" class="accent">Siguiente</button>
      </div>
    </div>
    <div id="dailyStart" class="row">
      <button class="accent" onclick="startDaily()">Comenzar reto de hoy</button>
    </div>
    <div id="dailyDone" class="hidden"><b>‚úÖ Reto del d√≠a completado.</b></div>
  </section>

  <!-- ===== HISTORY ===== -->
  <section id="historyView" class="card hidden">
    <h2>üìà Historial</h2>
    <canvas id="histChart" width="900" height="220"></canvas>
    <ul id="histList" class="list"></ul>
  </section>

  <!-- ===== BADGES ===== -->
  <section id="badgesView" class="card hidden">
    <h2>üèÖ Medallas</h2>
    <div id="badgesBox"></div>
  </section>
</section>

<script>
/* ================== UTILIDADES ================== */
const $ = sel => document.querySelector(sel);
function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function sample(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function shuffle(arr){ return arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]); }
function fmtTime(s){ const m=Math.floor(s/60), r=s%60; return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`; }
function todayKey(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function hashStem(s){ let h=0; for(let i=0;i<s.length;i++){ h=(h*31 + s.charCodeAt(i))|0; } return String(h); }

/* ================== ANTI-REPETICI√ìN por usuario/tema ================== */
function seenKey(u,s,a,t){ return `seen:${u}:${s}:${a}:${t}`; }
function rememberStem(u,s,a,t, stem){
  const key = seenKey(u,s,a,t);
  const arr = JSON.parse(localStorage.getItem(key)||"[]");
  arr.push(hashStem(stem));
  if(arr.length>50) arr.shift(); // recuerda las √∫ltimas 50
  localStorage.setItem(key, JSON.stringify(arr));
}
function isSeen(u,s,a,t, stem){
  const key = seenKey(u,s,a,t);
  const arr = JSON.parse(localStorage.getItem(key)||"[]");
  return arr.includes(hashStem(stem));
}

/* ================== CURR√çCULO jer√°rquico: Asignatura ‚Üí √Årea ‚Üí Tema ================== */
const CURRICULUM = {
  "Matem√°ticas": {
    areas: {
      "Geometr√≠a": {
        topics: {
          "Pit√°goras": {
            theory:`<h3>Teorema de Pit√°goras</h3><p>En un tri√°ngulo rect√°ngulo, a¬≤ + b¬≤ = c¬≤. Identifica catetos (lados que forman el √°ngulo recto) e hipotenusa (lado opuesto). √ötil para longitudes y verificaci√≥n de tri√°ngulos rectos.</p>`,
            examples:[{title:"Ejemplo 1", steps:["Catetos 6 y 8 ‚Üí c=‚àö(36+64)=10"]},{title:"Ejemplo 2", steps:["c=13, b=5 ‚Üí a=‚àö(13¬≤‚àí5¬≤)=12"]}],
            generators:[
              // Terna pitag√≥rica
              ()=>{ const sets=[[3,4,5],[5,12,13],[6,8,10],[8,15,17],[7,24,25],[9,12,15]]; const [a,b,c]=sample(sets);
                    const opts=shuffle([c,c+1,c-1,c+2]).map(String);
                    const explain=`Usamos c = ‚àö(a¬≤+b¬≤). Con a=${a} y b=${b}, c=‚àö(${a*a}+${b*b})=${c}.`;
                    return {stem:`Catetos ${a} y ${b}. ¬øHipotenusa?`, choices:opts, answerIndex:opts.indexOf(String(c)), explain}; },
              // Hallar cateto
              ()=>{ const c=sample([10,13,17,25]); const b=sample([3,4,5,7,8,12,24].filter(x=>x<c)); const a=Math.round(Math.sqrt(c*c - b*b));
                    const ask=sample(["a","b"]); const correct = (ask==="a")? a : b;
                    const opts=shuffle([correct,correct+1,correct-1,correct+2]).map(String);
                    return {stem:`Tri√°ngulo rect√°ngulo: c=${c} y ${ask==="a"?"b="+b:"a="+a}. ¬ø${ask}?`, choices:opts, answerIndex:opts.indexOf(String(correct)), explain:`Reordenamos: a=‚àö(c¬≤‚àíb¬≤) o b=‚àö(c¬≤‚àía¬≤).`}; },
              // Per√≠metro de tri√°ngulo rect√°ngulo
              ()=>{ const sets=[[5,12,13],[6,8,10],[8,15,17]]; const [a,b,c]=sample(sets); const P=a+b+c;
                    const opts=shuffle([P,P+2,P-2,P+4]).map(String);
                    return {stem:`Tri√°ngulo rect√°ngulo con lados ${a}, ${b}, ${c}. ¬øPer√≠metro?`, choices:opts, answerIndex:opts.indexOf(String(P)), explain:`El per√≠metro es la suma de sus lados: P=a+b+c=${P}.`}; }
            ]
          },
          "√Åreas de tri√°ngulos": {
            theory:`<h3>√Årea del tri√°ngulo</h3><p>A = (base √ó altura)/2. En tri√°ngulos rectos, los catetos pueden servir de base y altura. Si no hay altura, usa f√≥rmulas derivadas (Her√≥n, trigonometr√≠a).</p>`,
            examples:[{title:"Ejemplo", steps:["b=10, h=6 ‚Üí A=30 u¬≤"]}],
            generators:[
              ()=>{ const b=randInt(6,30), h=randInt(3,20); const A=(b*h)/2;
                    const opts=shuffle([A,A+2,A-2,A+4]).map(String);
                    return {stem:`Tri√°ngulo con base ${b} y altura ${h}. ¬ø√Årea?`, choices:opts, answerIndex:opts.indexOf(String(A)), explain:`A=(b¬∑h)/2=${b}¬∑${h}/2=${A}.`}; },
              ()=>{ const a=randInt(5,20), b=randInt(5,20); const A=(a*b)/2;
                    const opts=shuffle([A,A+3,A-3,A+5]).map(String);
                    return {stem:`Tri√°ngulo rect√°ngulo con catetos ${a} y ${b}. ¬ø√Årea?`, choices:opts, answerIndex:opts.indexOf(String(A)), explain:`En tri√°ngulo rect√°ngulo, cateto=base y el otro=altura: A=ab/2=${A}.`}; }
            ]
          },
          "Per√≠metro y circunferencia": {
            theory:`<h3>Circunferencia</h3><p>La longitud de circunferencia es C = 2œÄr. El di√°metro es 2r y no debe confundirse con el radio.</p>`,
            examples:[{title:"Ejemplo", steps:["r=7 ‚Üí C ‚âà 43.98"]}],
            generators:[
              ()=>{ const r=randInt(2,25); const C=(2*Math.PI*r).toFixed(2);
                    const opts=shuffle([C,(Math.PI*r).toFixed(2),(2*Math.PI*(r+1)).toFixed(2),(2*Math.PI*(r-1)).toFixed(2)]);
                    return {stem:`C√≠rculo de radio ${r}. ¬øLongitud de la circunferencia (aprox.)?`, choices:opts, answerIndex:opts.indexOf(String(C)), explain:`C=2œÄr. Con r=${r}, C‚âà${C}.`}; }
            ]
          },
          "Semejanza y Tales": {
            theory:`<h3>Semejanza de tri√°ngulos</h3><p>Tri√°ngulos semejantes tienen √°ngulos iguales y lados proporcionales. El Teorema de Tales permite calcular longitudes en tri√°ngulos y paralelas.</p>`,
            examples:[{title:"Ejemplo", steps:["Si k=2, los lados se duplican"]}],
            generators:[
              ()=>{ const k=randInt(2,5); const a=randInt(3,9); const A=a*k;
                    const opts=shuffle([A,A+1,A-1,A+2]).map(String);
                    return {stem:`Dos tri√°ngulos semejantes con raz√≥n k=${k}. Si un lado del peque√±o mide ${a}, ¬øcu√°nto mide el hom√≥logo del grande?`, choices:opts, answerIndex:opts.indexOf(String(A)), explain:`En semejanza, todos los lados se multiplican por k: A=${a}¬∑${k}=${A}.`}; }
            ]
          }
        }
      },
      "√Ålgebra": {
        topics: {
          "Ecuaciones lineales": {
            theory:`<h3>Ecuaci√≥n lineal</h3><p>Para ax+b=c, despeja x con operaciones inversas: x=(c‚àíb)/a. Verifica sustituyendo.</p>`,
            examples:[{title:"Ejemplo", steps:["3x+2=14 ‚Üí x=4"]}],
            generators:[
              ()=>{ let a=randInt(2,12), b=randInt(-20,20), x=randInt(-15,15); const c=a*x+b; const ans=(c-b)/a;
                    const opts=shuffle([ans,ans+1,ans-1,ans+2]).map(String);
                    return {stem:`Si ${a}x ${b>=0?'+':''}${b} = ${c}, ¬øx?`, choices:opts, answerIndex:opts.indexOf(String(ans)), explain:`Restamos ${b} y dividimos entre ${a}: x=(${c}-${b})/${a}=${ans}.`}; },
              ()=>{ const m=randInt(-5,5)||1, n=randInt(-10,10); const x=randInt(-8,8); const y=m*x+n;
                    const opts=shuffle([y,y+1,y-1,y+2]).map(String);
                    return {stem:`En y=${m}x ${n>=0?'+':''}${n}, si x=${x}, ¬øy?`, choices:opts, answerIndex:opts.indexOf(String(y)), explain:`Sustituimos x: y=${m}¬∑${x}${n>=0?'+':''}${n}=${y}.`}; }
            ]
          },
          "Sistemas 2√ó2": {
            theory:`<h3>Sistemas 2√ó2</h3><p>Resuelve por sustituci√≥n/eliminaci√≥n. Comprueba en ambas ecuaciones.</p>`,
            examples:[{title:"Ejemplo", steps:["x+y=6; x‚àíy=2 ‚Üí x=4, y=2"]}],
            generators:[
              ()=>{ const x=randInt(-5,9), y=randInt(-5,9);
                    const a=randInt(1,6), b=randInt(1,6), c=randInt(1,6), d=randInt(1,6);
                    const s1=a*x+b*y, s2=c*x+d*y; const ask=sample(["x","y"]); const correct=ask==="x"?x:y;
                    const opts=shuffle([correct,correct+1,correct-1,correct+2]).map(String);
                    return {stem:`${a}x+${b}y=${s1}; ${c}x+${d}y=${s2}. ¬ø${ask}?`, choices:opts, answerIndex:opts.indexOf(String(correct)), explain:`El sistema est√° construido para soluci√≥n (${x},${y}). Eliminando una variable obtienes ${ask}=${correct}.`}; },
              ()=>{ const x=randInt(1,10), y=randInt(1,10); const k=randInt(2,5);
                    const s1=x+y, s2=k*x+k*y;
                    const opts=shuffle([x,x+1,x-1,x+2]).map(String);
                    return {stem:`x+y=${s1}; ${k}x+${k}y=${s2}. ¬øx?`, choices:opts, answerIndex:opts.indexOf(String(x)), explain:`La segunda ecuaci√≥n es k veces la primera; usa la primera para despejar x en funci√≥n de y y viceversa.`}; }
            ]
          }
        }
      },
      "Probabilidad": {
        topics: {
          "Dados y eventos": {
            theory:`<h3>Probabilidad con dados</h3><p>Resultados equiprobables (6). P(E)=favorables/6.</p>`,
            examples:[{title:"Ejemplo", steps:["par ‚Üí 3/6=1/2"]}],
            generators:[
              ()=>{ const ask=sample(["par","m√∫ltiplo de 3","mayor que 4","primo"]);
                    let correct="1/2"; if(ask==="m√∫ltiplo de 3") correct="1/3"; if(ask==="mayor que 4") correct="1/3"; if(ask==="primo") correct="1/2"; // {2,3,5}
                    const opts=shuffle([correct,"1/6","2/3","5/6"]);
                    return {stem:`Se lanza un dado. Probabilidad de obtener n√∫mero ${ask}.`, choices:opts, answerIndex:opts.indexOf(correct), explain:`Cuenta casos favorables y divide por 6. Par: 3/6; m√∫ltiplo de 3: 2/6; >4: 2/6; primo: 3/6.`}; }
            ]
          }
        }
      }
    }
  },
  "Ciencias Naturales": {
    areas: {
      "Biolog√≠a": {
        topics: {
          "Org√°nulos celulares": {
            theory:`<h3>Org√°nulos</h3><p>Cloroplasto (fotos√≠ntesis), mitocondria (ATP), ribosomas (prote√≠nas), n√∫cleo (ADN).</p>`,
            examples:[{title:"Ejemplo", steps:["Cloroplasto ‚Üí fotos√≠ntesis"]}],
            generators:[
              ()=>{ const pairs=[["Cloroplasto","Fotos√≠ntesis"],["Mitocondria","Respiraci√≥n celular"],["Ribosoma","S√≠ntesis de prote√≠nas"],["N√∫cleo","Almacena ADN"]];
                    const [org,func]=sample(pairs); const wrong=shuffle(pairs.filter(p=>p[0]!==org).map(p=>p[1])).slice(0,3);
                    const all=shuffle([func,...wrong]);
                    return {stem:`Funci√≥n principal de ${org}:`, choices:all, answerIndex:all.indexOf(func), explain:`${org} se asocia con ‚Äú${func}‚Äù.`}; },
              ()=>{ const pair=sample([["Lisosoma","Digesti√≥n intracelular"],["Aparato de Golgi","Empaque y secreci√≥n"]]);
                    const [org,func]=pair; const wrong=shuffle(["Fotos√≠ntesis","Respiraci√≥n celular","S√≠ntesis de prote√≠nas","Almacena ADN"].filter(x=>x!==func)).slice(0,3);
                    const all=shuffle([func,...wrong]);
                    return {stem:`Funci√≥n principal de ${org}:`, choices:all, answerIndex:all.indexOf(func), explain:`${org} ‚Üí ${func}.`}; }
            ]
          }
        }
      },
      "Qu√≠mica": {
        topics: {
          "Molaridad": {
            theory:`<h3>Molaridad</h3><p>M = n/V (moles por litro).</p>`,
            examples:[{title:"Ejemplo", steps:["2 mol en 1 L ‚Üí 2 M"]}],
            generators:[
              ()=>{ const mol=randInt(1,5), L=randInt(1,4); const M=(mol/L).toFixed(2);
                    const opts=shuffle([M,(mol/(L+1)).toFixed(2),(mol/(L+2)).toFixed(2),(mol/(L+0.5)).toFixed(2)]);
                    return {stem:`Una disoluci√≥n con ${mol} mol en ${L} L. ¬øM?`, choices:opts, answerIndex:opts.indexOf(String(M)), explain:`Aplicamos M=n/V=${mol}/${L}=${M} M.`}; },
              ()=>{ const M=sample([0.5,1,1.5,2]); const V=randInt(1,3); const n=(M*V).toFixed(2);
                    const opts=shuffle([n,(M*(V+1)).toFixed(2),(M*(V-0.5)).toFixed(2),(M*(V+2)).toFixed(2)]);
                    return {stem:`Para preparar ${V} L de una soluci√≥n ${M} M, ¬øcu√°ntos moles de soluto necesitas?`, choices:opts, answerIndex:opts.indexOf(String(n)), explain:`n=M¬∑V=${M}¬∑${V}=${n} mol.`}; }
            ]
          },
          "Balanceo b√°sico": {
            theory:`<h3>Balanceo</h3><p>Igualamos √°tomos por lado con coeficientes.</p>`,
            examples:[{title:"Ejemplo", steps:["Fe + O‚ÇÇ ‚Üí Fe‚ÇÇO‚ÇÉ ‚Üí 4Fe + 3O‚ÇÇ ‚Üí 2Fe‚ÇÇO‚ÇÉ"]}],
            generators:[
              ()=>{ const x=randInt(1,4), y=2*randInt(1,6); const o2=x+y/4;
                    const opts=shuffle([o2,o2+0.5,o2-0.5,o2+1]).map(String);
                    return {stem:`En la combusti√≥n de C${x}H${y}, ¬øcoeficiente de O‚ÇÇ al balancear?`, choices:opts, answerIndex:opts.indexOf(String(o2)), explain:`En productos: CO‚ÇÇ (2x O) y H‚ÇÇO (y/2 O). Total 2x+y/2; divide entre 2 ‚Üí x+y/4.`}; }
            ]
          }
        }
      },
      "Ecolog√≠a": {
        topics: {
          "Niveles tr√≥ficos": {
            theory:`<h3>Cadenas tr√≥ficas</h3><p>Productores, consumidores (primarios, secundarios, terciarios) y descomponedores.</p>`,
            examples:[{title:"Ejemplo", steps:["Productores ‚Üí plantas y algas"]}],
            generators:[
              ()=>{ const correct="Productores"; const opts=shuffle([correct,"Consumidores primarios","Descomponedores","Consumidores terciarios"]);
                    return {stem:`¬øQui√©nes capturan energ√≠a solar directamente?`, choices:opts, answerIndex:opts.indexOf(correct), explain:`Los productores realizan fotos√≠ntesis.`}; }
            ]
          }
        }
      }
    }
  },
  "Sociales": {
    areas: {
      "Historia de Colombia": {
        topics: {
          "Independencia": {
            theory:`<h3>Independencia</h3><p>1810 (inicio), 1819 (Boyac√°), 1821 (C√∫cuta).</p>`,
            examples:[{title:"Ejemplo", steps:["1819 ‚Üí Boyac√°"]}],
            generators:[
              ()=>{ const items=[["1810","inicio del proceso de independencia"],["1819","Batalla de Boyac√°"],["1821","Constituci√≥n de C√∫cuta"]];
                    const [anio,desc]=sample(items); const opts=shuffle([anio,"1816","1830","1849"]);
                    return {stem:`A√±o asociado a: ${desc}`, choices:opts, answerIndex:opts.indexOf(anio), explain:`${desc} ‚Üí ${anio}.`}; },
              ()=>{ const lugar=sample([["Boyac√°","7 de agosto de 1819"],["Cartagena","1811"],["Santaf√©","20 de julio de 1810"]]);
                    const [sit,fecha]=lugar; const opts=shuffle([fecha,"1812","1820","1832"]);
                    return {stem:`Fecha destacada asociada a ${sit}`, choices:opts, answerIndex:opts.indexOf(fecha), explain:`Se ubica el hito hist√≥rico en su cronolog√≠a correcta.`}; }
            ]
          }
        }
      },
      "Geograf√≠a": {
        topics: {
          "R√≠os de Colombia": {
            theory:`<h3>R√≠os principales</h3><p>Magdalena, Cauca, Orinoco, Amazonas, Putumayo.</p>`,
            examples:[{title:"Ejemplo", steps:["M√°s largo ‚Üí Magdalena"]}],
            generators:[
              ()=>{ const correct="Magdalena"; const opts=shuffle([correct,"Cauca","Putumayo","Orinoco"]);
                    return {stem:`¬øR√≠o m√°s largo de Colombia?`, choices:opts, answerIndex:opts.indexOf(correct), explain:`El Magdalena es el m√°s extenso en el pa√≠s.`}; },
              ()=>{ const mouth=sample([["Amazonas","Atl√°ntico"],["Magdalena","Caribe"],["Orinoco","Atl√°ntico"]]);
                    const [rio,oc]=mouth; const opts=shuffle([oc,"Pac√≠fico","Mediterr√°neo","√çndico"]);
                    return {stem:`¬øEn qu√© oc√©ano desemboca (directa o indirectamente) el ${rio}?`, choices:opts, answerIndex:opts.indexOf(oc), explain:`Se reconoce la cuenca y salida al mar del r√≠o indicado.`}; }
            ]
          }
        }
      }
    }
  },
  "Lectura Cr√≠tica": {
    areas: {
      "Comprensi√≥n": {
        topics: {
          "Idea principal": {
            theory:`<h3>Idea principal</h3><p>Resume el mensaje global: tema + enfoque del autor.</p>`,
            examples:[{title:"Ejemplo", steps:["Texto sobre abejas ‚Üí papel clave en polinizaci√≥n"]}],
            generators:[
              ()=>{ const a=sample(["abejas","manglares","bosques urbanos"]); const b=a==="abejas"?"polinizaci√≥n":(a==="manglares"?"costeras":"temperatura de ciudades");
                    const p=`Los ${a} son esenciales para la ${b}.`; const correct=p;
                    const opts=shuffle([correct,`Se critica a los ${a}.`,`Son irrelevantes.`,`Solo importan en laboratorios.`]);
                    return {stem:`Texto: ‚Äú${p}‚Äù ¬øIdea principal?`, choices:opts, answerIndex:opts.indexOf(correct), explain:`Elegimos la oraci√≥n que sintetiza el mensaje global.`}; },
              ()=>{ const t=sample(["El reciclaje reduce residuos.","Las lluvias limpian el aire en ocasiones."]);
                    const opts=shuffle([t,"El autor rechaza el reciclaje.","La lluvia siempre empeora el aire.","No hay postura del autor."]);
                    return {stem:`¬øCu√°l enuncia la idea principal del fragmento?`, choices:opts, answerIndex:opts.indexOf(t), explain:`La idea principal condensa el aporte central del texto.`}; }
            ]
          }
        }
      },
      "Cohesi√≥n": {
        topics: {
          "Conectores": {
            theory:`<h3>Conectores</h3><p>Causa (‚Äúporque/por ello‚Äù), oposici√≥n (‚Äúsin embargo‚Äù), concesi√≥n (‚Äúaunque‚Äù).</p>`,
            examples:[{title:"Ejemplo", steps:["Se invirti√≥ en ciclorrutas ‚Üí por ello aument√≥ su uso"]}],
            generators:[
              ()=>{ const correct="por ello"; const opts=shuffle([correct,"sin embargo","aunque","a pesar de"]);
                    return {stem:`Completa: ‚ÄúLa ciudad invirti√≥ en ciclorrutas; ___, el uso de la bicicleta aument√≥.‚Äù`, choices:opts, answerIndex:opts.indexOf(correct), explain:`Segunda oraci√≥n es consecuencia ‚Üí ‚Äúpor ello‚Äù.`}; },
              ()=>{ const correct="sin embargo"; const opts=shuffle([correct,"por ello","porque","por ejemplo"]);
                    return {stem:`‚ÄúEl servicio es r√°pido; ___, a veces se retrasa en horas pico.‚Äù`, choices:opts, answerIndex:opts.indexOf(correct), explain:`Hay contraste ‚Üí ‚Äúsin embargo‚Äù.`}; }
            ]
          }
        }
      }
    }
  },
  "Ingl√©s": {
    areas: {
      "Vocabulary": {
        topics: {
          "Synonyms": {
            theory:`<h3>Synonyms</h3><p>El mejor sin√≥nimo mantiene el matiz.</p>`,
            examples:[{title:"Ejemplo", steps:["smart ‚âà intelligent"]}],
            generators:[
              ()=>{ const pairs=[["reliable","trustworthy"],["quick","rapid"],["smart","intelligent"],["tiny","small"],["brave","courageous"],["angry","mad"],["happy","glad"]];
                    const [w,syn]=sample(pairs); const wrong=shuffle(pairs.filter(p=>p[0]!==w).map(p=>p[1])).slice(0,3);
                    const all=shuffle([syn,...wrong]);
                    return {stem:`Choose the best synonym for ‚Äú${w}‚Äù.`, choices:all, answerIndex:all.indexOf(syn), explain:`‚Äú${w}‚Äù ‚âà ‚Äú${syn}‚Äù en la mayor√≠a de contextos.`}; }
            ]
          }
        }
      },
      "Reading": {
        topics: {
          "Inferencias": {
            theory:`<h3>Inferencias</h3><p>Deducciones razonables basadas en lo expl√≠cito.</p>`,
            examples:[{title:"Ejemplo", steps:["prefers quiet places ‚Üí likes quiet places"]}],
            generators:[
              ()=>{ const place=sample(["the library","the park","the museum","the countryside"]);
                    const p=`Tom visits ${place} on weekends to study and relax. He prefers quiet places.`;
                    const correct="He likes quiet places."; const opts=shuffle([correct,"He hates weekends","He works there","He never studies"]);
                    return {stem:`Read: ‚Äú${p}‚Äù What can we infer?`, choices:opts, answerIndex:opts.indexOf(correct), explain:`La preferencia expl√≠cita permite la inferencia correcta.`}; }
            ]
          }
        }
      }
    }
  }
};

/* ================== PERFIL / THEME / PUNTOS ================== */
function setTheme(u){ document.documentElement.setAttribute('data-theme', u); }
function pointsKey(u){ return `points:${u}`; }
function getPoints(u){ return parseInt(localStorage.getItem(pointsKey(u))||"0",10); }
function addPoints(u,delta){ const p=getPoints(u)+delta; localStorage.setItem(pointsKey(u), String(p)); return p; }
function setActiveUser(u){ localStorage.setItem("activeUser", u); setTheme(u); }
function getActiveUser(){ return localStorage.getItem("activeUser") || null; }

/* ================== PIN (contrase√±a) ================== */
function pinKey(u){ return `pin:${u}`; }
function getPIN(u){ return localStorage.getItem(pinKey(u)); }
function setPIN(u,pin){ localStorage.setItem(pinKey(u), pin); }
function enterWithPIN(user, inputId){
  const typed = $( '#'+inputId ).value.trim();
  if(typed.length!==4){ alert("PIN de 4 d√≠gitos"); return; }
  const saved = getPIN(user);
  if(!saved){ setPIN(user, typed); } else if(saved!==typed){ alert("PIN incorrecto"); return; }
  setActiveUser(user);
  $("#loginView").classList.add("hidden");
  $("#appView").classList.remove("hidden");
  $("#who").textContent = user;
  renderHomeScores();
  initStudy();
  initPractice();
  showSection('study');
}

/* ================== NAVEGACI√ìN ================== */
const sections = { study:"#studyView", practice:"#practiceView", exam:"#examView", daily:"#dailyView", history:"#historyView", badges:"#badgesView"};
function showSection(name){
  for(const k in sections){ const el=$(sections[k]); (k===name)?el.classList.remove("hidden"):el.classList.add("hidden"); }
  $("#navStudy").classList.toggle("active", name==='study');
  $("#navPractice").classList.toggle("active", name==='practice');
  $("#navExam").classList.toggle("active", name==='exam');
  $("#navDaily").classList.toggle("active", name==='daily');
  $("#navHistory").classList.toggle("active", name==='history');
  $("#navBadges").classList.toggle("active", name==='badges');
}
$("#navStudy").onclick = ()=>showSection('study');
$("#navPractice").onclick = ()=>{ showSection('practice'); nextQuestion(); };
$("#navExam").onclick = ()=>showSection('exam');
$("#navDaily").onclick = ()=>showDaily();
$("#navHistory").onclick = ()=>showHistory();
$("#navBadges").onclick = ()=>renderBadges();
function logout(){ localStorage.removeItem("activeUser"); $("#appView").classList.add("hidden"); $("#loginView").classList.remove("hidden"); renderHomeScores(); }
function renderHomeScores(){ $("#albaPoints").textContent=getPoints("Alba"); $("#laraPoints").textContent=getPoints("Lara"); $("#albaBadgesCount").textContent=getAllBadges("Alba").length; $("#laraBadgesCount").textContent=getAllBadges("Lara").length; }

/* ================== HELPERS de curr√≠culo ================== */
function listSubjects(){ return Object.keys(CURRICULUM); }
function listAreas(subject){ return Object.keys((CURRICULUM[subject]||{}).areas||{}); }
function listTopics(subject, area){ const a=(CURRICULUM[subject]||{}).areas||{}; return Object.keys((a[area]||{}).topics||{}); }
function getTopicNode(subject,area,topic){ return (((CURRICULUM[subject]||{}).areas||{})[area]||{}).topics?.[topic] || null; }

/* ================== ESTUDIO ================== */
let studyIdx = 0; // √≠ndice de pregunta de estudio
function initStudy(){
  const s=$("#studySubject"), a=$("#studyArea"), t=$("#studyTopic");
  s.innerHTML = listSubjects().map(x=>`<option>${x}</option>`).join('');
  s.onchange = ()=>{ a.innerHTML = listAreas(s.value).map(x=>`<option>${x}</option>`).join(''); a.dispatchEvent(new Event('change')); };
  a.onchange = ()=>{ t.innerHTML = listTopics(s.value, a.value).map(x=>`<option>${x}</option>`).join(''); renderStudy(); };
  t.onchange = renderStudy;
  s.dispatchEvent(new Event('change'));
  $("#studyPractice").onclick = ()=>{
    $("#pSubject").value = s.value;
    fillAreas("#pArea", s.value);
    $("#pArea").value = a.value;
    fillTopics("#pTopic", s.value, a.value);
    $("#pTopic").value = t.value;
    showSection('practice'); nextQuestion();
  };
  $("#studyNextTopic").onclick = ()=>{
    const topics = listTopics(s.value, a.value);
    const idx = Math.max(0, topics.indexOf(t.value));
    const next = topics[(idx+1) % topics.length];
    t.value = next; renderStudy();
  };
  renderStudy();
}
function renderStudy(){
  const s=$("#studySubject").value, a=$("#studyArea").value, t=$("#studyTopic").value;
  const node = getTopicNode(s,a,t);
  const sc=$("#studyContent"), ex=$("#studyExamples"), sq=$("#studyQs"), qa=$("#studyQA");
  if(!node){ sc.innerHTML="(No hay contenido todav√≠a)"; ex.classList.add("hidden"); sq.classList.add("hidden"); return; }
  sc.innerHTML = node.theory || "(sin teor√≠a)";
  if(node.examples && node.examples.length){
    ex.classList.remove("hidden");
    ex.innerHTML = `<h4>Ejemplos resueltos</h4>` + node.examples.map(e=>`<div class="card"><b>${e.title}</b><ol class="small">${e.steps.map(s=>`<li>${s}</li>`).join('')}</ol></div>`).join('');
  } else ex.classList.add("hidden");
  // Generar 6 preguntas de estudio con anti-repetici√≥n
  const qs=[]; const u=getActiveUser();
  let tries=0;
  while(qs.length<6 && tries<100){
    const q = sample(node.generators)();
    if(!isSeen(u,s,a,t,q.stem)){ qs.push(q); rememberStem(u,s,a,t,q.stem); }
    tries++;
  }
  if(qs.length===0){ // de emergencia, sin filtro
    for(let i=0;i<3;i++) qs.push(sample(node.generators)());
  }
  studyIdx=0;
  sq.classList.remove("hidden");
  drawStudyQA(qs);
}
function drawStudyQA(qs){
  const qa=$("#studyQA"); qa.innerHTML="";
  const q = qs[studyIdx];
  const meta = document.createElement('div'); meta.className="small muted"; meta.textContent = `Pregunta ${studyIdx+1} de ${qs.length}`;
  qa.appendChild(meta);
  const stem = document.createElement('div'); stem.style.fontWeight="600"; stem.textContent=q.stem; qa.appendChild(stem);
  const box = document.createElement('div'); qa.appendChild(box);
  const res = document.createElement('div'); res.id="studyRes"; res.className="result hidden"; qa.appendChild(res);
  const exp = document.createElement('div'); exp.id="studyExp"; exp.className="small muted hidden"; qa.appendChild(exp);
  q.choices.forEach((ch,i)=>{
    const b=document.createElement('button'); b.className='option'; b.textContent=ch;
    b.onclick = ()=>{
      [...box.children].forEach((el,idx)=>{
        el.disabled=true;
        if(idx===q.answerIndex) el.classList.add('correct');
        if(idx===i && i!==q.answerIndex) el.classList.add('incorrect');
      });
      res.textContent = (i===q.answerIndex)?"‚úÖ ¬°Correcto!":"‚ùå Incorrecto";
      res.className = "result " + ((i===q.answerIndex)?"good":"bad");
      exp.textContent = q.explain || "";
      exp.classList.remove("hidden");
      const nav = document.createElement('div'); nav.style.marginTop="8px";
      const btn = document.createElement('button'); btn.className='accent'; btn.textContent = (studyIdx<qs.length-1)?"Siguiente (estudio)":"Repetir tema";
      btn.onclick = ()=>{
        if(studyIdx<qs.length-1){ studyIdx++; drawStudyQA(qs); }
        else { renderStudy(); }
      };
      nav.appendChild(btn); qa.appendChild(nav);
    };
    box.appendChild(b);
  });
}

/* ================== PR√ÅCTICA ================== */
const pS=$("#pSubject"), pA=$("#pArea"), pT=$("#pTopic");
let current=null;
function fillAreas(sel, subject){ const el=$(sel); el.innerHTML = listAreas(subject).map(x=>`<option>${x}</option>`).join(''); }
function fillTopics(sel, subject, area){ const el=$(sel); el.innerHTML = listTopics(subject, area).map(x=>`<option>${x}</option>`).join(''); }

function initPractice(){
  pS.innerHTML = listSubjects().map(x=>`<option>${x}</option>`).join('');
  pS.onchange = ()=>{ fillAreas("#pArea", pS.value); pA.dispatchEvent(new Event('change')); };
  pA.onchange = ()=>{ fillTopics("#pTopic", pS.value, pA.value); onTopicChange(); };
  pT.onchange = onTopicChange;
  pS.dispatchEvent(new Event('change'));
  $("#reset").onclick = ()=>{
    const u=getActiveUser(), s=pS.value, a=pA.value, t=pT.value;
    if(confirm(`¬øBorrar progreso de ${u} en ${s}/${a}/${t}?`)){
      localStorage.removeItem(abilityKey(u,s,a,t));
      localStorage.removeItem(statsKey(u,s,a,t));
      renderStats(u,s,a,t); nextQuestion();
    }
  };
  $("#skipTopic").onclick = ()=>{
    const topics = listTopics(pS.value, pA.value);
    const idx = topics.indexOf(pT.value);
    const next = topics[(idx+1) % topics.length];
    pT.value = next; onTopicChange();
  };
}
function onTopicChange(){ const u=getActiveUser(), s=pS.value, a=pA.value, t=pT.value; renderStats(u,s,a,t); nextQuestion(); }

function renderStats(u,subject,area,topic){
  const st=statsGet(u,subject,area,topic), ability=abilityGet(u,subject,area,topic);
  $("#stats").innerHTML = `
    <span class="pill">Usuario: <b>${u}</b></span>
    <span class="pill">Asignatura: <b>${subject}</b></span>
    <span class="pill">√Årea: <b>${area}</b></span>
    <span class="pill">Tema: <b>${topic}</b></span>
    <span class="pill">Aciertos: <b>${st.right}</b></span>
    <span class="pill">Errores: <b>${st.wrong}</b></span>
    <span class="pill">Vistas: <b>${st.seen}</b></span>
    <span class="pill">Nivel: <b>${ability.toFixed(2)}</b></span>
    <span class="pill">Puntos: <b>${getPoints(u)}</b></span>
  `;
}
function buildQuestion(subject,area,topic){
  const node=getTopicNode(subject,area,topic);
  const u=getActiveUser();
  let tries=0;
  if(node && node.generators && node.generators.length){
    while(tries<60){
      const g = sample(node.generators); const b = g();
      if(!isSeen(u,subject,area,topic,b.stem)){ rememberStem(u,subject,area,topic,b.stem);
        return { id:`gen-${subject}-${area}-${topic}-${Date.now()}-${Math.floor(Math.random()*1e6)}`, subject, area, topic, stem:b.stem, choices:b.choices, answerIndex:b.answerIndex, explain:b.explain, difficulty:0.3, generated:true };
      }
      tries++;
    }
    // si todas vistas, devuelve igualmente una
    const b = sample(node.generators)();
    return { id:`gen-${subject}-${area}-${topic}-${Date.now()}-${Math.floor(Math.random()*1e6)}`, subject, area, topic, stem:b.stem, choices:b.choices, answerIndex:b.answerIndex, explain:b.explain, difficulty:0.3, generated:true };
  }
  // Fallbacks si no hubiera generadores
  const ts=listTopics(subject,area);
  if(ts.length){ const t = sample(ts); return buildQuestion(subject,area,t); }
  const as=listAreas(subject); if(as.length){ const a2=sample(as); return buildQuestion(subject,a2, sample(listTopics(subject,a2))); }
  const s2=sample(listSubjects()); const a3=sample(listAreas(s2)); const t3=sample(listTopics(s2,a3));
  return buildQuestion(s2,a3,t3);
}
function renderQuestion(q){
  $("#meta").textContent = `${q.subject} ‚Ä¢ ${q.area} ‚Ä¢ ${q.topic}`;
  $("#question").textContent = q.stem;
  $("#result").className = "result hidden"; $("#result").textContent="";
  $("#similar").classList.add("hidden");
  $("#next").classList.add("hidden");
  const opts=$("#options"); opts.innerHTML="";
  $("#explanation").classList.add("hidden"); $("#explanation").innerHTML="";
  current=q;
  q.choices.forEach((ch,i)=>{
    const b=document.createElement('button');
    b.type="button"; b.className='option'; b.textContent=ch;
    b.addEventListener('click', ()=>selectOption(i), {once:true});
    opts.appendChild(b);
  });
}
function nextQuestion(){
  const u=getActiveUser(), s=pS.value, a=pA.value, t=pT.value;
  const q = buildQuestion(s,a,t); renderQuestion(q);
}
$("#similar").onclick = ()=>{
  const s=pS.value, a=pA.value, t=pT.value;
  const g=buildQuestion(s,a,t);
  renderQuestion(g);
};
$("#next").onclick = nextQuestion;

function abilityKey(u,s,a,t){ return `ability:${u}:${s}:${a}:${t}`; }
function statsKey(u,s,a,t){ return `stats:${u}:${s}:${a}:${t}`; }
function abilityGet(u,s,a,t){ const v=localStorage.getItem(abilityKey(u,s,a,t)); return v?parseFloat(v):0.30; }
function abilitySet(u,s,a,t,val){ localStorage.setItem(abilityKey(u,s,a,t), String(clamp(val,0.05,0.95))); }
function statsGet(u,s,a,t){ const v=localStorage.getItem(statsKey(u,s,a,t)); return v?JSON.parse(v):{seen:0,right:0,wrong:0}; }
function statsSet(u,s,a,t,st){ localStorage.setItem(statsKey(u,s,a,t), JSON.stringify(st)); }

function selectOption(index){
  const u=getActiveUser(), s=pS.value, a=pA.value, t=pT.value;
  const correct = index===current.answerIndex;
  [...$("#options").children].forEach((el,i)=>{
    el.disabled=true;
    if(i===current.answerIndex) el.classList.add('correct');
    if(i===index && !correct) el.classList.add('incorrect');
    if(i===index && correct) el.classList.add('correct');
  });
  const st=statsGet(u,s,a,t); st.seen += 1; correct ? st.right++ : st.wrong++; statsSet(u,s,a,t,st);
  let ab=abilityGet(u,s,a,t); ab += correct ? 0.05 : -0.07; abilitySet(u,s,a,t,ab);
  const delta = correct ? 10 : 0; addPoints(u, delta);
  trackHistory(u, s+" ‚Ä¢ "+a, t, correct);
  checkStreak(u, correct);
  renderStats(u,s,a,t);
  $("#result").textContent = correct ? "‚úÖ ¬°Correcto!" : "‚ùå Incorrecto";
  $("#result").className = "result " + (correct ? "good" : "bad");
  $("#explanation").innerHTML = `<div>${current.explain??''}</div>`;
  $("#explanation").classList.remove("hidden");
  $("#similar").classList.remove("hidden");
  $("#next").classList.remove("hidden");
  if(!correct){ $("#similar").classList.add("accent"); $("#next").classList.remove("accent"); }
  else { $("#similar").classList.remove("accent"); $("#next").classList.add("accent"); }
  evaluateBadges(u);
}

/* ================== EXAM / RETO / HISTORIAL / MEDALLAS ================== */
let exam = null, timerId=null;
function startExam(){
  const count=parseInt($("#examCount").value,10);
  const minutes=parseInt($("#examMinutes").value,10);
  const qs=[];
  for(let i=0;i<count;i++){
    const s=sample(listSubjects()), a=sample(listAreas(s)), t=sample(listTopics(s,a));
    qs.push(buildQuestion(s,a,t));
  }
  exam = { items: qs, answers: Array(qs.length).fill(null), idx: 0, seconds: minutes*60 };
  $("#examTotal").textContent = String(qs.length);
  renderExamQuestion();
  $("#examCard").classList.remove("hidden");
  $("#examSummary").classList.add("hidden");
  startTimer();
}
function renderExamQuestion(){
  const i=exam.idx, q=exam.items[i];
  $("#examIndex").textContent = String(i+1);
  $("#examQ").textContent = q.stem;
  const box=$("#examOptions"); box.innerHTML="";
  q.choices.forEach((ch,ci)=>{
    const b=document.createElement('button');
    b.type="button"; b.className='option'; b.textContent=ch;
    const chosen = exam.answers[i]===ci;
    if(chosen) b.classList.add('correct');
    b.onclick = ()=>{ exam.answers[i]=ci; renderExamQuestion(); };
    box.appendChild(b);
  });
  $("#examPrev").onclick = ()=>{ if(exam.idx>0){ exam.idx--; renderExamQuestion(); } };
  $("#examNext").onclick = ()=>{ if(exam.idx<exam.items.length-1){ exam.idx++; renderExamQuestion(); } };
}
function startTimer(){ stopTimer(); $("#examTimer").textContent = fmtTime(exam.seconds); timerId = setInterval(()=>{ exam.seconds--; $("#examTimer").textContent = fmtTime(exam.seconds); if(exam.seconds<=0){ finishExam(); } },1000); }
function stopTimer(){ if(timerId){ clearInterval(timerId); timerId=null; } }
function finishExam(){
  stopTimer();
  const u=getActiveUser();
  let correct=0;
  const list=$("#sumList"); list.innerHTML="";
  exam.items.forEach((q,i)=>{
    const chosen = exam.answers[i];
    const ok = chosen===q.answerIndex;
    if(ok) correct++;
    const li=document.createElement('li');
    const letter = idx=>["A","B","C","D"][idx] || (idx+1);
    li.innerHTML = `<div><b>${i+1}.</b> ${q.stem}</div>
      <div class="small ${ok?'good':'bad'}">Tu respuesta: ${chosen==null?'<i>No respondida</i>':letter(chosen)} ‚Äî Correcta: ${letter(q.answerIndex)}</div>
      <div class="small muted" style="margin-left:8px">${q.explain||''}</div>`;
    list.appendChild(li);
  });
  $("#sumCorrect").textContent = String(correct);
  $("#sumTotal").textContent = String(exam.items.length);
  const points = correct*10;
  $("#sumScore").textContent = String(points);
  addPoints(u, points);
  trackHistory(u, "Simulador", "Mixto", null, correct, exam.items.length);
  evaluateBadges(u, true, correct===exam.items.length);
  $("#examSummary").classList.remove("hidden");
}

let daily=null;
function dailyKey(u){ return `daily:${u}:${todayKey()}`; }
function hasDaily(u){ return localStorage.getItem(dailyKey(u))==="done"; }
function startDaily(){
  const u=getActiveUser();
  if(hasDaily(u)){ showDaily(); return; }
  const qs=[];
  for(let i=0;i<10;i++){
    const s=sample(listSubjects()), a=sample(listAreas(s)), t=sample(listTopics(s,a));
    qs.push(buildQuestion(s,a,t));
  }
  daily = { items:qs, idx:0, wrong:false };
  $("#dailyStart").classList.add("hidden");
  $("#dailyDone").classList.add("hidden");
  $("#dailyCard").classList.remove("hidden");
  renderDaily();
}
function renderDaily(){
  const q=daily.items[daily.idx];
  $("#dailyIndex").textContent = String(daily.idx+1);
  $("#dailyQ").textContent = q.stem;
  const box=$("#dailyOptions"); box.innerHTML="";
  $("#dailyResult").className="result hidden"; $("#dailyExplain").classList.add("hidden"); $("#dailyExplain").textContent="";
  q.choices.forEach((ch,i)=>{
    const b=document.createElement('button');
    b.className='option'; b.textContent=ch;
    b.onclick = ()=>{
      const ok = i===q.answerIndex;
      if(!ok) daily.wrong=true;
      [...box.children].forEach((el,idx)=>{
        el.disabled=true;
        if(idx===q.answerIndex) el.classList.add('correct');
        if(idx===i && !ok) el.classList.add('incorrect');
        if(idx===i && ok) el.classList.add('correct');
      });
      $("#dailyResult").textContent = ok ? "‚úÖ ¬°Correcto!" : "‚ùå Incorrecto";
      $("#dailyResult").className = "result " + (ok ? "good" : "bad");
      $("#dailyExplain").textContent = q.explain || "";
      $("#dailyExplain").classList.remove("hidden");
    };
    box.appendChild(b);
  });
  $("#dailyNext").onclick = ()=>{
    if(daily.idx < daily.items.length-1){ daily.idx++; renderDaily(); }
    else {
      const u=getActiveUser();
      localStorage.setItem(dailyKey(u),"done");
      const gained = daily.wrong? (10*daily.items.length) : (20*daily.items.length);
      addPoints(u, gained);
      trackHistory(u, "Reto diario", "Mixto", null, daily.items.length - (daily.wrong?1:0), daily.items.length);
      evaluateBadges(u, false, !daily.wrong);
      showDaily();
    }
  };
}
function showDaily(){
  const u=getActiveUser();
  $("#dailyCard").classList.add("hidden");
  $("#dailyStart").classList.toggle("hidden", hasDaily(u));
  $("#dailyDone").classList.toggle("hidden", !hasDaily(u));
  showSection('daily');
}

/* ================== HISTORIAL ================== */
function histKey(u){ return `history:${u}`; }
function getHistory(u){ return JSON.parse(localStorage.getItem(histKey(u))||"[]"); }
function pushHistory(u, rec){ const h=getHistory(u); h.push(rec); localStorage.setItem(histKey(u), JSON.stringify(h.slice(-200))); }
function trackHistory(u, subject, topic, correct=null, correctCount=0, total=1){
  const rec = { date: new Date().toISOString(), subject, topic, correct, correctCount, total };
  pushHistory(u, rec);
}
function showHistory(){
  const u=getActiveUser(); const h=getHistory(u);
  const list=$("#histList"); list.innerHTML = h.slice(-20).reverse().map(r=>{
    const d=new Date(r.date); const dd=d.toLocaleString();
    const label = (r.correct===null) ? `Examen/Reto: ${r.correctCount}/${r.total}` : (r.correct ? "‚úîÔ∏è" : "‚úñÔ∏è");
    return `<li>${dd} ‚Äî <b>${r.subject}</b> / ${r.topic} ‚Äî ${label}</li>`;
  }).join('');
  const daily = {};
  for(const r of h){
    const day = r.date.slice(0,10);
    if(!daily[day]) daily[day]={correct:0,total:0};
    daily[day].correct += (r.correct===null? r.correctCount : (r.correct?1:0));
    daily[day].total   += (r.correct===null? r.total : 1);
  }
  const days = Object.keys(daily).sort().slice(-7);
  const data = days.map(d=>({day:d, acc: daily[d].total? (daily[d].correct/daily[d].total)*100 : 0}));
  drawChart($("#histChart"), data);
  showSection('history');
}
function drawChart(canvas, data){
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const pad=30, w=canvas.width, h=canvas.height, cw=w-pad*2, ch=h-pad*2;
  ctx.strokeStyle="#ccc"; ctx.fillStyle="#000"; ctx.font="12px system-ui";
  ctx.beginPath(); ctx.moveTo(pad,pad); ctx.lineTo(pad,h-pad); ctx.lineTo(w-pad,h-pad); ctx.stroke();
  const bw = cw / Math.max(1,data.length);
  data.forEach((d,i)=>{
    const x=pad + i*bw + bw*0.15;
    const val = d.acc; const bh = (val/100)*ch;
    ctx.fillStyle = getActiveUser()==="Alba" ? "#e91e63" : "#7e57c2";
    ctx.fillRect(x, h-pad-bh, bw*0.7, bh);
    ctx.fillStyle="#000"; ctx.fillText(String(Math.round(val))+"%", x, h-pad-bh-4);
    ctx.fillText(d.day.slice(5), x, h-pad+14);
  });
}

/* ================== MEDALLAS ================== */
const BADGE_LIST = [
  {id:"streak10", name:"Racha 10", desc:"10 aciertos seguidos en pr√°ctica."},
  {id:"hundredQs", name:"Centenaria", desc:"100 preguntas contestadas (en pr√°ctica)."},
  {id:"mathMax", name:"Nivel top Mate", desc:"Nivel ‚â• 0.80 en Matem√°ticas/√Ålgebra."},
  {id:"perfectExam", name:"Examen perfecto", desc:"Simulador con 100% correctas."},
  {id:"dailyPerfect", name:"Reto perfecto", desc:"Reto diario sin errores."}
];
function badgesKey(u){ return `badges:${u}`; }
function getAllBadges(u){ return JSON.parse(localStorage.getItem(badgesKey(u))||"[]"); }
function awardBadge(u,id){ const b=getAllBadges(u); if(!b.includes(id)){ b.push(id); localStorage.setItem(badgesKey(u), JSON.stringify(b)); } }
let streak=0;
function checkStreak(u, correct){
  streak = correct ? streak+1 : 0;
  if(streak>=10) awardBadge(u,"streak10");
  const total = Object.keys(localStorage).filter(k=>k.startsWith(`stats:${u}:`)).map(k=>JSON.parse(localStorage.getItem(k)).seen||0).reduce((a,b)=>a+b,0);
  if(total>=100) awardBadge(u,"hundredQs");
  const level = abilityGet(u,"Matem√°ticas","√Ålgebra","Ecuaciones lineales");
  if(level>=0.80) awardBadge(u,"mathMax");
}
function evaluateBadges(u, fromExam=false, perfect=false){
  if(fromExam && perfect) awardBadge(u,"perfectExam");
  if(!fromExam && perfect) awardBadge(u,"dailyPerfect");
}
function renderBadges(){
  const u=getActiveUser(); const owned=new Set(getAllBadges(u));
  $("#badgesBox").innerHTML = BADGE_LIST.map(b=>{
    const has=owned.has(b.id);
    return `<span class="badge" style="${has?'':'opacity:.4'}">üèÖ <b>${b.name}</b> ‚Äî ${b.desc}</span>`;
  }).join('');
  showSection('badges');
}

/* ================== INICIO ================== */
(function start(){
  const u=getActiveUser();
  setTheme(u||"Alba");
  renderHomeScores();
  if(u){
    $("#loginView").classList.add("hidden");
    $("#appView").classList.remove("hidden");
    $("#who").textContent=u;
    initStudy();
    initPractice();
    showSection('study');
  } else {
    $("#loginView").classList.remove("hidden");
    $("#appView").classList.add("hidden");
  }
})();
</script>

<div class="small muted" style="margin-top:16px">
  Saber 11 ‚Äî Curr√≠culo jer√°rquico (Asignatura ‚Üí √Årea ‚Üí Tema), estudio con 6 preguntas y ‚ÄúSiguiente tema‚Äù, pr√°ctica con anti-repetici√≥n (recuerda 50 √≠tems por tema), generadores ampliados y explicaciones.
</div>
</body>
</html>
